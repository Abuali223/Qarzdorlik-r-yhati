<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qarz Tizimi - Pro Green</title>
    
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ============== DIZAYN (YASHIL PALITRA -06) ============== */
        :root {
            --col-deep: #2F5233;   
            --col-main: #337B01;   
            --col-soft: #76B947;   
            --col-pale: #BEEAC5;   
            
            --primary: var(--col-main);
            --primary-hover: var(--col-deep);
            --bg-body: #ffffff;
            --text-main: #2D2D2D;
            --text-muted: #6b7280;
            --border: var(--col-pale);
            
            --danger: #ef4444;
            --radius: 10px;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg-body); display: flex; height: 100vh; overflow: hidden; color: var(--text-main); }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 20px; background: #fdfdfd; }
        .brand { color: var(--primary); font-size: 20px; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: var(--radius); color: var(--text-muted); cursor: pointer; transition: .2s; font-weight: 600; border: none; background: none; width: 100%; text-align: left; font-size: 14px; }
        .nav-item:hover { background: var(--col-pale); color: var(--col-deep); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(51, 123, 1, 0.25); }

        /* Main Content */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-header { height: 60px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 32px; justify-content: space-between; background: #fff; }
        .content-area { padding: 30px; overflow-y: auto; height: 100%; }

        /* UI Elements */
        .btn { padding: 9px 16px; border-radius: var(--radius); border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 13px; transition: .2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(51,123,1,0.2); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--col-pale); }
        .btn-danger { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; }

        /* Forms */
        .form-control { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: var(--radius); outline: none; margin-top: 5px; font-size: 14px; transition: .2s; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(51,123,1,0.1); }
        .input-label { font-size: 12px; font-weight: 700; color: var(--col-deep); margin-bottom: 2px; display: block; }

        /* Table */
        .card { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 30px; background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 14px 16px; background: #f0fdf4; color: var(--col-deep); font-size: 12px; text-transform: uppercase; font-weight: 700; border-bottom: 1px solid var(--border); }
        td { padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; font-size: 14px; }
        tr:hover td { background: #f9fff9; }
        tr.warn-row td { background: rgba(239, 68, 68, 0.05); }

        /* Action Buttons */
        .icon-btn { padding: 6px; border-radius: 6px; border: none; background: none; cursor: pointer; color: var(--text-muted); transition: .2s; }
        .icon-btn:hover { background: var(--col-pale); color: var(--primary); }
        .icon-btn.delete:hover { background: #fee2e2; color: var(--danger); }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { padding: 20px; border: 1px solid var(--border); border-radius: 12px; background: #fff; }
        .stat-val { font-size: 22px; font-weight: 800; margin-top: 5px; color: var(--primary); }

        /* Dialog (Center Fix) */
        dialog { 
            position: fixed; inset: 0; margin: auto; z-index: 9999;
            border: none; border-radius: 12px; width: 92%; max-width: 800px; 
            padding: 0; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); 
        }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { padding: 24px; max-height: 75vh; overflow-y: auto; background: #fcfcfc; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #fff; }

        /* Helper Classes */
        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }
        
        .product-img { width: 36px; height: 36px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); background: #eee; }
        
        /* Login Overlay */
        #loginOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; }
        #loginOverlay.show { display: flex; }
        .login-box { background: white; padding: 30px; border-radius: 12px; width: 320px; text-align: center; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i data-feather="box"></i> Qarz Tizimi</div>
        <nav class="nav-menu">
            <button onclick="switchTab('mijozlar')" class="nav-item active" id="nav-mijozlar"><i data-feather="users"></i> Mijozlar</button>
            <button onclick="switchTab('omborxona')" class="nav-item" id="nav-omborxona"><i data-feather="layers"></i> Omborxona</button>
            <button onclick="switchTab('harajatlar')" class="nav-item" id="nav-harajatlar"><i data-feather="trending-down"></i> Harajatlar</button>
            <button onclick="switchTab('statistika')" class="nav-item" id="nav-statistika"><i data-feather="pie-chart"></i> Hisobot</button>
            <div style="margin-top: auto; border-top: 1px solid var(--border); padding-top: 10px;">
                <button id="btnSaveCloud" class="nav-item" style="color:var(--primary)"><i data-feather="cloud"></i> Cloudga Saqlash</button>
                <button id="btnLogout" class="nav-item" style="color:var(--danger)"><i data-feather="log-out"></i> Chiqish</button>
            </div>
        </nav>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <h3 id="page-title" style="color:var(--col-deep)">Mijozlar</h3>
            <div style="text-align: right;">
                <span style="font-size:12px; font-weight:bold; color:var(--primary)" id="auth-status">...</span><br>
                <span style="font-size:11px; color:#888" id="current-date"></span>
            </div>
        </header>

        <div class="content-area">
            
            <div id="view-mijozlar" class="view-section active">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px">
                    <input id="search-client" class="form-control" style="max-width:300px; margin:0" placeholder="Qidiruv: Ism yoki Telefon..." oninput="renderClients()">
                    <button class="btn btn-primary" onclick="openClientModal()"><i data-feather="plus"></i> Yangi Mijoz</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="font-size:11px; font-weight:700; color:#888; text-transform:uppercase">Jami Qarz</div>
                        <div class="stat-val" id="st-debt" style="color:var(--danger)">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size:11px; font-weight:700; color:#888; text-transform:uppercase">Qaytgan</div>
                        <div class="stat-val" id="st-paid">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size:11px; font-weight:700; color:#888; text-transform:uppercase">Qoldiq</div>
                        <div class="stat-val" id="st-remain" style="color:var(--text-main)">0</div>
                    </div>
                </div>

                <div class="card">
                    <table>
                        <thead><tr><th>#</th><th>Mijoz</th><th>Telefon</th><th>Dona</th><th>Sm</th><th>Jami Qarz</th><th>To'langan</th><th>Qoldiq</th><th style="text-align:right">Amallar</th></tr></thead>
                        <tbody id="tbody-clients"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-omborxona" class="view-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                    <h2 style="color:var(--primary)">Omborxona</h2>
                    <button class="btn btn-primary" onclick="openProductModal()"><i data-feather="plus"></i> Mahsulot Qo'shish</button>
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>Rasm</th><th>Nomi</th><th>Birlik</th><th>Qoldiq</th><th>Sotish Narxi</th><th style="text-align:right">Amallar</th></tr></thead>
                        <tbody id="tbody-warehouse"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-harajatlar" class="view-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                    <h2 style="color:var(--primary)">Harajatlar</h2>
                    <button class="btn btn-primary" onclick="openExpenseModal()"><i data-feather="minus-circle"></i> Harajat Qo'shish</button>
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>Sana</th><th>Sabab</th><th>Summa</th><th style="text-align:right">Amal</th></tr></thead>
                        <tbody id="tbody-expenses"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-statistika" class="view-section">
                <h2 style="color:var(--primary); margin-bottom:20px">Statistika</h2>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="stat-card"><canvas id="chartPie"></canvas></div>
                    <div class="stat-card"><canvas id="chartBar"></canvas></div>
                </div>
            </div>

        </div>
    </main>

    <dialog id="dlgClient">
        <div class="modal-header">
            <span style="font-weight:700; font-size:18px" id="dlgClientTitle">Mijoz</span>
            <button onclick="closeModal('dlgClient')" style="border:none; background:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <form onsubmit="saveClient(event)">
            <div class="modal-body">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                    <div style="grid-column: span 2"><label class="input-label">Ism Familiya</label><input id="c_name" class="form-control" required></div>
                    <div><label class="input-label">Telefon</label><input id="c_phone" class="form-control"></div>
                    <div><label class="input-label">Eski Qarz (so'm)</label><input id="c_given" type="number" class="form-control" value="0" placeholder="0"></div>
                    <div><label class="input-label">Boshlang'ich Dona</label><input id="c_qty_dona" type="number" step="any" class="form-control"></div>
                    <div><label class="input-label">Boshlang'ich Sm</label><input id="c_len_sm" type="number" step="any" class="form-control"></div>
                    <div><label class="input-label">Narx (1 dona)</label><input id="c_price_dona" type="number" class="form-control"></div>
                    <div><label class="input-label">Narx (1 sm)</label><input id="c_price_sm" type="number" class="form-control"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('dlgClient')">Yopish</button>
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgHistory">
        <div class="modal-header">
            <span style="font-weight:700; font-size:18px"><span id="histClientName"></span> — Tarix</span>
            <button onclick="closeModal('dlgHistory')" style="border:none; background:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <div class="modal-body">
            
            <div style="background:white; padding:20px; border:1px solid var(--border); border-radius:12px; margin-bottom:20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);">
                <h4 style="color:var(--col-deep); margin-bottom:15px; display:flex; gap:8px; align-items:center"><i data-feather="shopping-cart" style="width:18px"></i> Yangi Savdo</h4>
                <form onsubmit="addTrade(event)">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                        <div style="grid-column: span 2">
                            <label class="input-label">Ombordan tanlash</label>
                            <select id="t_prod" class="form-control" onchange="onProductSelect()">
                                <option value="">-- Tanlanmagan --</option>
                            </select>
                        </div>
                        
                        <div style="border:1px dashed var(--col-soft); padding:10px; border-radius:8px;">
                            <label class="input-label">Dona Soni</label>
                            <input id="t_qty_dona" type="number" step="any" class="form-control" placeholder="0">
                            <label class="input-label" style="margin-top:5px">Narx (1 dona)</label>
                            <input id="t_price_dona" type="number" class="form-control" placeholder="0">
                        </div>

                        <div style="border:1px dashed var(--col-soft); padding:10px; border-radius:8px;">
                            <label class="input-label">Uzunlik (Sm)</label>
                            <input id="t_len_sm" type="number" step="any" class="form-control" placeholder="0">
                            <label class="input-label" style="margin-top:5px">Narx (1 sm)</label>
                            <input id="t_price_sm" type="number" class="form-control" placeholder="0">
                        </div>

                        <div style="grid-column: span 2">
                            <label class="input-label">Izoh</label>
                            <input id="t_note" class="form-control" placeholder="Masalan: Kabel...">
                        </div>
                        <div style="grid-column: span 2">
                            <button class="btn btn-primary" style="width:100%">Savdoni Qo'shish</button>
                        </div>
                    </div>
                </form>
            </div>

            <div style="background:white; padding:20px; border:1px solid var(--border); border-radius:12px; margin-bottom:20px">
                <h4 style="color:var(--col-deep); margin-bottom:15px; display:flex; gap:8px; align-items:center"><i data-feather="credit-card" style="width:18px"></i> To'lov Qabul Qilish</h4>
                <form onsubmit="addPayment(event)" style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end">
                    <div>
                        <label class="input-label">To'lov Turi</label>
                        <select id="p_method" class="form-control">
                            <option value="Naqd">Naqd</option>
                            <option value="Karta">Plastik</option>
                            <option value="Click">Click</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Summa</label>
                        <input id="p_amount" type="number" class="form-control" required>
                    </div>
                    <button class="btn btn-primary">Saqlash</button>
                </form>
            </div>

            <div class="card" style="margin-bottom:0">
                <table style="font-size:13px">
                    <thead><tr><th>Sana</th><th>Ma'lumot</th><th>Hisob</th><th>Summa</th><th style="text-align:right">Amal</th></tr></thead>
                    <tbody id="tbody-history"></tbody>
                </table>
            </div>
        </div>
    </dialog>

    <dialog id="dlgProduct">
        <div class="modal-header">
            <span style="font-weight:700; font-size:18px" id="dlgProdTitle">Mahsulot</span>
            <button onclick="closeModal('dlgProduct')" style="border:none; background:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <form onsubmit="saveProduct(event)">
            <div class="modal-body">
                <div style="display:grid; gap:15px">
                    <div><label class="input-label">Nomi</label><input id="w_name" class="form-control" required></div>
                    <div>
                        <label class="input-label">Birlik</label>
                        <select id="w_unit" class="form-control">
                            <option value="dona">Dona</option>
                            <option value="sm">Sm / Metr</option>
                            <option value="kg">Kg</option>
                        </select>
                    </div>
                    <div><label class="input-label">Qoldiq</label><input id="w_qty" type="number" step="any" class="form-control" required></div>
                    <div><label class="input-label">Sotish Narxi</label><input id="w_price" type="number" class="form-control"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgExpense">
        <div class="modal-header"><span style="font-weight:700; font-size:18px">Harajat</span><button onclick="closeModal('dlgExpense')" style="border:none; background:none; cursor:pointer"><i data-feather="x"></i></button></div>
        <form onsubmit="saveExpense(event)">
            <div class="modal-body">
                <div style="display:grid; gap:15px">
                    <div><label class="input-label">Sana</label><input id="e_date" type="date" class="form-control" required></div>
                    <div><label class="input-label">Summa</label><input id="e_amount" type="number" class="form-control" required></div>
                    <div><label class="input-label">Sabab</label><input id="e_reason" class="form-control" required></div>
                </div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary">Saqlash</button></div>
        </form>
    </dialog>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-bottom:15px">Tizimga Kirish</h2>
            <div style="text-align:left; font-size:12px; color:#666; margin-bottom:10px">Admin: <b>kamerasony24@gmail.com</b></div>
            <input id="fb_email" value="kamerasony24@gmail.com" class="form-control" style="margin-bottom:10px">
            <input id="fb_password" type="password" placeholder="Parol" class="form-control" style="margin-bottom:20px">
            <button id="btnLogin" class="btn btn-primary" style="width:100%">Kirish</button>
            <div id="loginMsg" style="color:red; font-size:12px; margin-top:10px"></div>
        </div>
    </div>

    <script type="module">
        // 1. FIREBASE IMPORTS
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { initializeAppCheck, ReCaptchaV3Provider, getToken } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app-check.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        // 2. CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyA3I7m0ZfpchebCrnxtS0zOZq86eWducKs",
            authDomain: "alilazer-cd582.firebaseapp.com",
            projectId: "alilazer-cd582",
            storageBucket: "alilazer-cd582.appspot.com",
            messagingSenderId: "831212822404",
            appId: "1:831212822404:web:52a0c48d2c1cd1458cc7d1"
        };

        // 3. INIT
        const app = initializeApp(firebaseConfig);
        const appCheck = initializeAppCheck(app, { 
            provider: new ReCaptchaV3Provider("6Lfy3rUrAAAAAHVag7CVAw9q9kakVAmX_0PmcLmP"), 
            isTokenAutoRefreshEnabled: true 
        });
        const auth = getAuth(app);
        const db = getFirestore(app);
        const STATE_DOC = doc(db, "settings", "appState");

        const ADMIN_EMAIL = 'kamerasony24@gmail.com';

        // 4. LOCAL STORAGE KEYS
        const LS_CLIENTS = 'qarz_tolov_v8_units';
        const LS_EXP     = 'harajatlar_v3';
        const LS_ARCH    = 'clients_archive_v1';
        const LS_WH      = 'warehouse_v1';

        // 5. GLOBAL VARIABLES
        window.data = [];      // Clients
        window.warehouse = []; // Warehouse
        window.expenses = [];  // Expenses
        window.currentIndex = null; 
        window.currProdIdx = null;

        // 6. HELPER FUNCTIONS (Globally accessible)
        window.$ = id => document.getElementById(id);
        window.fmt = n => Number(n||0).toLocaleString('uz-UZ').replace(/,/g, ' '); // 10 000 format
        window.parseNum = v => {
            const s = String(v||'').replace(/\s/g,'').replace(/,/g,'.');
            return parseFloat(s) || 0;
        };
        window.genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        // 7. CORE LOGIC
        window.totalsForClient = (c) => {
            let totalDona = window.parseNum(c.qty_dona||0);
            let totalSm   = window.parseNum(c.len_sm||0);
            
            // Asosiy qarz hisobi
            let totalDebt = (totalDona * window.parseNum(c.price_dona||0)) + (totalSm * window.parseNum(c.price_sm||0));

            // Tarixdan qo'shish
            (c.history||[]).forEach(h => {
                if(h.type === undefined || h.type === 'trade') { // Eski format yoki yangi trade
                    const qd = window.parseNum(h.qty_dona);
                    const ls = window.parseNum(h.len_sm);
                    const pd = window.parseNum(h.price_dona);
                    const ps = window.parseNum(h.price_sm);
                    totalDona += qd; 
                    totalSm += ls;
                    totalDebt += (qd * pd) + (ls * ps);
                }
            });

            // To'lovlar
            let paid = window.parseNum(c.given||0);
            (c.payments||[]).forEach(p => paid += window.parseNum(p.amount));
            // Tarix ichidagi to'lovlar (yangi format)
            (c.history||[]).forEach(h => {
                if(h.type === 'pay') paid += window.parseNum(h.amount);
            });

            return { totalDona, totalSm, totalDebt, given: paid, remain: totalDebt - paid };
        };

        // --- RENDER FUNCTIONS ---
        window.renderClients = () => {
            const tbody = $('tbody-clients'); tbody.innerHTML = '';
            const search = $('search-client').value.toLowerCase();
            let tDebt=0, tPaid=0, tRemain=0;

            window.data.forEach((c, idx) => {
                const t = window.totalsForClient(c);
                const name = (c.name||'').toLowerCase();
                
                if(name.includes(search)) {
                    tDebt += t.totalDebt; tPaid += t.given; tRemain += t.remain;
                    const tr = document.createElement('tr');
                    if(t.remain > 0) tr.classList.add('warn-row');
                    tr.innerHTML = `
                        <td>${idx+1}</td>
                        <td><div style="font-weight:700; color:var(--primary)">${c.name}</div></td>
                        <td>${c.phone||''}</td>
                        <td>${window.fmt(t.totalDona)}</td>
                        <td>${window.fmt(t.totalSm)}</td>
                        <td>${window.fmt(t.totalDebt)}</td>
                        <td style="color:var(--col-soft)">${window.fmt(t.given)}</td>
                        <td style="color:var(--danger); font-weight:800">${window.fmt(t.remain)}</td>
                        <td style="text-align:right">
                            <button class="btn btn-primary" style="padding:6px 10px; font-size:12px" onclick="openHistory(${idx})">Tarix va Savdo</button>
                            <button class="icon-btn" onclick="editClient(${idx})"><i data-feather="edit-2"></i></button>
                            <button class="icon-btn delete" onclick="delRow(${idx})"><i data-feather="trash-2"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            $('st-debt').innerText = window.fmt(tDebt);
            $('st-paid').innerText = window.fmt(tPaid);
            $('st-remain').innerText = window.fmt(tRemain);
            feather.replace();
        };

        window.renderWarehouse = () => {
            const tbody = $('tbody-warehouse'); tbody.innerHTML = '';
            window.warehouse.forEach((w, i) => {
                tbody.innerHTML += `<tr>
                    <td><img src="${w.img || ''}" class="product-img"></td>
                    <td style="font-weight:600">${w.name}</td>
                    <td><span style="background:var(--col-pale); padding:2px 6px; border-radius:4px; font-size:12px; color:var(--col-deep)">${w.unit}</span></td>
                    <td style="font-weight:700">${window.fmt(w.qty)}</td>
                    <td>${window.fmt(w.price)}</td>
                    <td style="text-align:right">
                        <button class="icon-btn" onclick="editProduct(${i})"><i data-feather="edit"></i></button>
                        <button class="icon-btn delete" onclick="delProduct(${i})"><i data-feather="trash-2"></i></button>
                    </td></tr>`;
            });
            feather.replace();
        };

        window.renderExpenses = () => {
            const tbody=$('tbody-expenses'); tbody.innerHTML='';
            window.expenses.slice().reverse().forEach((e,i)=>{ 
                tbody.innerHTML+=`<tr><td>${e.date}</td><td>${e.reason}</td><td style="color:var(--danger);font-weight:700">-${window.fmt(e.amount)}</td>
                <td style="text-align:right"><button class="icon-btn delete" onclick="delExp(${window.expenses.length-1-i})"><i data-feather="trash-2"></i></button></td></tr>`; 
            });
        };

        // --- CLIENT ACTIONS ---
        window.openClientModal = () => { window.currentIndex=null; $('dlgClientTitle').innerText="Yangi Mijoz"; $('c_name').value=''; $('c_phone').value=''; $('c_given').value=0; $('dlgClient').showModal(); };
        window.editClient = (i) => { window.currentIndex=i; const c=window.data[i]; $('dlgClientTitle').innerText="Tahrirlash"; $('c_name').value=c.name; $('c_phone').value=c.phone; $('c_given').value=c.given; $('c_qty_dona').value=c.qty_dona; $('c_len_sm').value=c.len_sm; $('c_price_dona').value=c.price_dona; $('c_price_sm').value=c.price_sm; $('dlgClient').showModal(); };
        window.saveClient = (e) => {
            e.preventDefault();
            const client = {
                name: $('c_name').value, phone: $('c_phone').value, given: window.parseNum($('c_given').value),
                qty_dona: window.parseNum($('c_qty_dona').value), len_sm: window.parseNum($('c_len_sm').value),
                price_dona: window.parseNum($('c_price_dona').value), price_sm: window.parseNum($('c_price_sm').value),
                history: window.currentIndex!==null?window.data[window.currentIndex].history:[],
                payments: window.currentIndex!==null?window.data[window.currentIndex].payments:[],
                createdAt: Date.now()
            };
            if(window.currentIndex!==null) window.data[window.currentIndex]=client; else window.data.push(client);
            saveLocal(); $('dlgClient').close();
        };
        window.delRow = (i) => { if(confirm("Aniqmi?")) { window.data.splice(i,1); saveLocal(); } };

        // --- HISTORY & TRADE ---
        window.openHistory = (i) => {
            window.currentIndex = i;
            const c = window.data[i];
            $('histClientName').innerText = c.name;
            const sel = $('t_prod'); sel.innerHTML = '<option value="">-- Tanlanmagan --</option>';
            window.warehouse.forEach(w => sel.innerHTML += `<option value="${w.id}">${w.name} (${w.qty} ${w.unit})</option>`);
            
            // Reset & Open inputs
            $('t_qty_dona').value=''; $('t_price_dona').value='';
            $('t_len_sm').value=''; $('t_price_sm').value=''; $('t_note').value='';
            
            renderHistoryTable(); $('dlgHistory').showModal();
        };

        window.onProductSelect = () => {
            const id = $('t_prod').value;
            const w = window.warehouse.find(x => x.id === id);
            if(w) {
                if(w.unit === 'dona') $('t_price_dona').value = w.price;
                else $('t_price_sm').value = w.price;
            }
        };

        window.addTrade = (e) => {
            e.preventDefault();
            const prodId = $('t_prod').value;
            const qDona = window.parseNum($('t_qty_dona').value);
            const pDona = window.parseNum($('t_price_dona').value);
            const qSm = window.parseNum($('t_len_sm').value);
            const pSm = window.parseNum($('t_price_sm').value);
            
            let pName = $('t_note').value || 'Tovar';
            if(prodId) {
                const w = window.warehouse.find(x => x.id === prodId);
                const req = w.unit==='dona' ? qDona : qSm;
                if(w.qty < req) { alert("Omborda yetarli emas!"); return; }
                w.qty -= req;
                pName = w.name;
            }

            if(qDona <= 0 && qSm <= 0) { alert("Miqdor kiriting!"); return; }

            const rec = {
                type: 'trade', date: new Date().toLocaleDateString('uz-UZ'),
                prodId: prodId, name: pName,
                qty_dona: qDona, price_dona: pDona,
                len_sm: qSm, price_sm: pSm,
                note: $('t_note').value
            };
            
            const c = window.data[window.currentIndex];
            if(!c.history) c.history = [];
            c.history.push(rec);
            saveLocal(); saveWarehouse(); // Warehouse updated
            renderHistoryTable();
            $('t_qty_dona').value=''; $('t_len_sm').value=''; $('t_note').value='';
        };

        window.addPayment = (e) => {
            e.preventDefault();
            const rec = {
                type: 'pay', date: new Date().toLocaleDateString('uz-UZ'),
                method: $('p_method').value, amount: window.parseNum($('p_amount').value)
            };
            const c = window.data[window.currentIndex];
            if(!c.history) c.history = [];
            c.history.push(rec);
            saveLocal(); renderHistoryTable(); $('p_amount').value='';
        };

        window.renderHistoryTable = () => {
            const tbody = $('tbody-history'); tbody.innerHTML = '';
            const hist = window.data[window.currentIndex].history || [];
            
            hist.slice().reverse().forEach((h, idx) => {
                const realIdx = hist.length - 1 - idx;
                const tr = document.createElement('tr');
                
                if(h.type === 'trade' || h.type === undefined) {
                    let math = ''; let total = 0;
                    if(h.qty_dona > 0) { math += `<div>${h.qty_dona} dona x ${window.fmt(h.price_dona)}</div>`; total += h.qty_dona * h.price_dona; }
                    if(h.len_sm > 0) { math += `<div>${h.len_sm} sm x ${window.fmt(h.price_sm)}</div>`; total += h.len_sm * h.price_sm; }

                    tr.innerHTML = `<td>${h.date}</td><td><b>${h.name||''}</b><br><small>${h.note||''}</small></td>
                        <td style="font-size:12px; color:#555">${math}</td><td style="font-weight:700">${window.fmt(total)}</td>
                        <td style="text-align:right"><button class="icon-btn delete" onclick="delHist(${realIdx})"><i data-feather="x"></i></button></td>`;
                } else {
                    tr.innerHTML = `<td>${h.date}</td><td>To'lov (${h.method})</td><td>-</td>
                        <td style="color:var(--primary); font-weight:700">+${window.fmt(h.amount)}</td>
                        <td style="text-align:right"><button class="icon-btn delete" onclick="delHist(${realIdx})"><i data-feather="x"></i></button></td>`;
                }
                tbody.appendChild(tr);
            });
            feather.replace();
        };

        window.delHist = (idx) => {
            if(!confirm("Aniqmi?")) return;
            const h = window.data[window.currentIndex].history[idx];
            if(h.type==='trade' && h.prodId) {
                const w = window.warehouse.find(x => x.id === h.prodId);
                if(w) w.qty += (w.unit==='dona' ? h.qty_dona : h.len_sm);
            }
            window.data[window.currentIndex].history.splice(idx,1);
            saveLocal(); saveWarehouse(); renderHistoryTable();
        };

        // --- WAREHOUSE & EXPENSE CRUD ---
        window.openProductModal = () => { window.currProdIdx=null; $('dlgProdTitle').innerText="Yangi Mahsulot"; $('w_name').value=''; $('w_qty').value=''; $('w_price').value=''; $('dlgProduct').showModal(); };
        window.editProduct = (i) => { window.currProdIdx=i; const w=window.warehouse[i]; $('dlgProdTitle').innerText="Tahrirlash"; $('w_name').value=w.name; $('w_unit').value=w.unit; $('w_qty').value=w.qty; $('w_price').value=w.price; $('dlgProduct').showModal(); };
        window.saveProduct = (e) => {
            e.preventDefault();
            const file = $('w_img_file').files[0];
            const reader = new FileReader();
            const finalize = (img) => {
                const data = { id: window.currProdIdx!==null?window.warehouse[window.currProdIdx].id:window.genId(), name:$('w_name').value, unit:$('w_unit').value, qty:window.parseNum($('w_qty').value), price:window.parseNum($('w_price').value) };
                if(img) data.img = img; else if(window.currProdIdx!==null) data.img = window.warehouse[window.currProdIdx].img;
                if(window.currProdIdx!==null) window.warehouse[window.currProdIdx]=data; else window.warehouse.push(data);
                saveWarehouse(); $('dlgProduct').close();
            };
            if(file) { reader.readAsDataURL(file); reader.onload = () => finalize(reader.result); } else finalize(null);
        };
        window.delProduct = (i) => { if(confirm("Aniqmi?")) { window.warehouse.splice(i,1); saveWarehouse(); } };

        window.openExpenseModal = () => { $('e_date').valueAsDate=new Date(); $('e_amount').value=''; $('e_reason').value=''; $('dlgExpense').showModal(); };
        window.saveExpense = (e) => { e.preventDefault(); window.expenses.push({ date:$('e_date').value, reason:$('e_reason').value, amount:window.parseNum($('e_amount').value) }); saveExpenses(); $('dlgExpense').close(); };
        window.delExp = (i) => { if(confirm("Aniqmi?")) { window.expenses.splice(i,1); saveExpenses(); } };

        // --- SAVE/LOAD & FIREBASE SYNC ---
        function saveLocal(){ localStorage.setItem(LS_CLIENTS, JSON.stringify(window.data)); renderClients(); }
        function saveWarehouse(){ localStorage.setItem(LS_WH, JSON.stringify(window.warehouse)); renderWarehouse(); }
        function saveExpenses(){ localStorage.setItem(LS_EXP, JSON.stringify(window.expenses)); renderExpenses(); }
        
        function loadAll(){
            try { window.data = JSON.parse(localStorage.getItem(LS_CLIENTS) || '[]'); } catch { window.data=[]; }
            try { window.warehouse = JSON.parse(localStorage.getItem(LS_WH) || '[]'); } catch { window.warehouse=[]; }
            try { window.expenses = JSON.parse(localStorage.getItem(LS_EXP) || '[]'); } catch { window.expenses=[]; }
            renderClients(); renderWarehouse(); renderExpenses();
        }

        async function saveToCloud(){
            if(!auth.currentUser) return alert("Avval kiring!");
            try{
                await setDoc(STATE_DOC, {
                    clients: window.data,
                    warehouse: window.warehouse,
                    expenses: window.expenses,
                    updatedAt: Date.now()
                }, {merge:true});
                alert("Cloudga saqlandi ✅");
            }catch(e){ alert("Xato: "+e.message); }
        }

        async function loadFromCloud(){
            try{
                const snap = await getDoc(STATE_DOC);
                if(snap.exists()){
                    const d = snap.data();
                    localStorage.setItem(LS_CLIENTS, JSON.stringify(d.clients||[]));
                    localStorage.setItem(LS_WH, JSON.stringify(d.warehouse||[]));
                    localStorage.setItem(LS_EXP, JSON.stringify(d.expenses||[]));
                    window.location.reload();
                }
            }catch(e){ console.error(e); }
        }

        // --- AUTH ---
        $('btnLogin').onclick = async () => {
            try{
                await signInWithEmailAndPassword(auth, $('fb_email').value, $('fb_password').value);
                $('loginOverlay').classList.remove('show');
                loadFromCloud();
            }catch(e){ $('loginMsg').textContent="Xato: "+e.message; }
        }
        $('btnLogout').onclick = async () => { await signOut(auth); window.location.reload(); }
        $('btnSaveCloud').onclick = saveToCloud;

        onAuthStateChanged(auth, u => {
            if(u){
                $('auth-status').textContent=`Admin: ${u.email}`; 
                $('loginOverlay').classList.remove('show');
            } else {
                $('auth-status').textContent="Kirilmagan"; 
                $('loginOverlay').classList.add('show');
            }
        });

        // --- CHARTS & EXPORT ---
        window.switchTab = switchTab;
        window.closeModal = id => $(id).close();
        window.renderCharts = () => {
            const ctxP=$('chartPie'), ctxB=$('chartBar');
            const debtors = window.data.map(c => ({name: c.name, debt: window.totalsForClient(c).remain})).filter(x => x.debt > 0).sort((a,b)=>b.debt-a.debt).slice(0,5);
            if(window.myPie) window.myPie.destroy();
            window.myPie = new Chart(ctxP, { type:'doughnut', data: { labels:debtors.map(d=>d.name), datasets:[{data:debtors.map(d=>d.debt), backgroundColor:['#337B01','#76B947','#2F5233','#BEEAC5','#88CC88']}] } });
        };
        window.exportExcel = () => {
            const wb = XLSX.utils.book_new();
            const cData = window.data.map(c => { const t=window.totalsForClient(c); return { "Mijoz":c.name, "Tel":c.phone, "Qarz":t.remain }; });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cData), "Mijozlar");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(window.warehouse), "Ombor");
            XLSX.writeFile(wb, "Hisobot.xlsx");
        };

        // INIT
        loadAll();
        feather.replace();
    </script>
</body>
</html>
