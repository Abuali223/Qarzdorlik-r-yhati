<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qarz Tizimi - Dashboard</title>
    
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* ============== 1. UMUMIY DIZAYN (CSS) ============== */
        :root {
            /* --- YANGI RANGLAR PALITRASI (Rasm asosida) --- */
            --col-deep-red: #702C2B;  /* Asosiy urg'u rangi (Primary) */
            --col-rose: #C56869;      /* Ikkilamchi, hover uchun */
            --col-peach: #DB9F95;     /* Hoshiyalar va ajratuvchilar */
            --col-light-pink: #F3D7D4; /* Umumiy fon rangi */
            
            --primary: var(--col-deep-red);
            --primary-hover: var(--col-rose);
            --bg-body: var(--col-light-pink);
            --bg-white: #ffffff;      /* Kartalar uchun oq fon saqlanadi kontrast uchun */
            
            --text-titles: var(--col-deep-red); /* Sarlavhalar uchun to'q rang */
            --text-body: #2c1a1a;     /* Asosiy matn o'qishli bo'lishi uchun juda to'q kulrang-qizil */
            --text-muted: var(--col-rose); /* Yordamchi matnlar */
            
            --border-color: var(--col-peach);
            --danger: #d32f2f;        /* O'chirish uchun standart qizil (lekin palitraga mosroq) */
            --sidebar-width: 260px;
            --hover-bg: var(--col-light-pink); /* Hover bo'lgandagi fon */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            background-color: var(--bg-body);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-body);
        }

        /* ============== 2. SIDEBAR (Chap menyu) ============== */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-white);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 24px;
            flex-shrink: 0;
            transition: transform 0.3s ease;
        }

        .brand {
            color: var(--primary);
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 12px;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 15px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background-color: var(--hover-bg);
            color: var(--text-titles);
        }

        .nav-item.active {
            background-color: var(--primary);
            color: white;
            /* Soyani ham asosiy rangga moslash */
            box-shadow: 0 4px 6px -1px rgba(112, 44, 43, 0.3);
        }

        .nav-item i {
            width: 20px;
            height: 20px;
        }

        .logout-btn {
            margin-top: auto;
            border: 1px solid var(--border-color);
            justify-content: center;
        }
        
        .logout-btn:hover {
            border-color: var(--danger);
            color: var(--danger);
            background: #fff5f5;
        }

        /* ============== 3. ASOSIY QISM (Main) ============== */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-body);
        }

        .top-header {
            background-color: var(--bg-white);
            height: 64px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 32px;
            font-weight: 700;
            font-size: 18px;
            color: var(--text-titles);
            justify-content: space-between;
        }

        .content-area {
            padding: 32px;
            overflow-y: auto;
            height: 100%;
        }

        /* ============== 4. UI ELEMENTLARI ============== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .page-title {
            font-size: 24px;
            font-weight: 800;
            color: var(--text-titles);
        }

        /* Tugmalar */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: 0.2s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(112, 44, 43, 0.2);
        }
        .btn-primary:hover { background-color: var(--primary-hover); }
        
        .btn-orange { background-color: #f59e0b; color: white; }
        .btn-orange:hover { background-color: #d97706; }

        .btn-outline {
            background: white;
            border: 1px solid var(--border-color);
            color: var(--text-body);
        }
        .btn-outline:hover { background: var(--hover-bg); border-color: var(--primary-hover); }

        /* Filtrlash qatori */
        .filter-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        input, select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            outline: none;
            color: var(--text-body);
            background: #fff;
            font-size: 14px;
        }
        input:focus, select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(112, 44, 43, 0.1);
        }

        /* JADVAL DIZAYNI */
        .card {
            background-color: var(--bg-white);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            text-align: left;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            /* Jadval sarlavhasi foni - och pushti */
            background: var(--hover-bg);
        }

        td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-body);
            font-size: 14px;
            vertical-align: middle;
        }

        tr:last-child td { border-bottom: none; }
        /* Qator ustiga borgandagi rang */
        tr:hover td { background-color: #fff5f5; }
        
        /* Qarzdorlar qatori - asosiy rangning juda och varianti */
        tr.warn-row td { background-color: rgba(112, 44, 43, 0.08); } 

        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .icon-btn {
            background: none;
            border: 1px solid transparent;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            color: var(--text-muted);
            transition: .2s;
        }
        .icon-btn:hover { background: var(--hover-bg); color: var(--text-titles); border-color: var(--border-color); }
        .icon-btn.edit { color: var(--primary-hover); }
        .icon-btn.edit:hover { background: var(--hover-bg); }
        .icon-btn.delete { color: var(--danger); }
        .icon-btn.delete:hover { background: #fff5f5; }

        /* STATISTIKA KARTALARI */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .stat-label { font-size: 13px; color: var(--text-muted); margin-bottom: 5px; font-weight: 500; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--text-titles); }
        
        /* DIALOG (MODAL) */
        dialog {
            border: none;
            border-radius: 12px;
            padding: 0;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        dialog::backdrop { background: rgba(112, 44, 43, 0.2); backdrop-filter: blur(2px); }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-titles);
        }
        .modal-title { font-weight: 700; font-size: 18px; }
        .modal-body { padding: 24px; display: grid; gap: 16px; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: var(--hover-bg);
        }
        .close-modal-btn { background: none; border: none; cursor: pointer; color: var(--text-muted); }
        .close-modal-btn:hover { color: var(--text-titles); }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }

        /* TAB SYSTEM (Mijozlar, Ombor...) */
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        /* Mobil uchun */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; z-index: 100; }
            .sidebar.show { left: 0; }
            .main-content { margin-left: 0; }
            .top-header { padding: 0 16px; }
            .content-area { padding: 16px; }
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <i data-feather="briefcase"></i> Qarz Tizimi
        </div>
        <nav class="nav-menu">
            <button onclick="switchTab('mijozlar')" class="nav-item active" id="nav-mijozlar">
                <i data-feather="users"></i> Mijozlar
            </button>
            <button onclick="switchTab('omborxona')" class="nav-item" id="nav-omborxona">
                <i data-feather="box"></i> Omborxona
            </button>
            <button onclick="switchTab('harajatlar')" class="nav-item" id="nav-harajatlar">
                <i data-feather="trending-down"></i> Harajatlar
            </button>
            <button onclick="switchTab('statistika')" class="nav-item" id="nav-statistika">
                <i data-feather="pie-chart"></i> Statistika
            </button>
            
            <button onclick="exportExcel()" class="nav-item logout-btn" style="justify-content: flex-start; margin-top: auto; border:none;">
                <i data-feather="download"></i> Excelga Yuklash
            </button>
        </nav>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <div style="display:flex; align-items:center; gap:10px">
                <button class="icon-btn" onclick="toggleSidebar()" style="display:none; @media(max-width:768px){display:block}"><i data-feather="menu"></i></button>
                <span id="page-header-title">Mijozlar</span>
            </div>
            <div style="font-size:14px; color:var(--text-muted)">
                Bugun: <span id="current-date"></span>
            </div>
        </header>

        <div class="content-area">

            <div id="view-mijozlar" class="view-section active">
                <div class="page-header">
                    <h1 class="page-title">Mijozlar Ro'yxati</h1>
                    <button class="btn btn-primary" onclick="openClientModal()">
                        <i data-feather="plus"></i> Yangi mijoz
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Jami Qarz</div>
                        <div class="stat-value" id="st-qarz" style="color:var(--danger)">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">To'langan</div>
                        <div class="stat-value" id="st-tolov" style="color:var(--primary)">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Jami Qoldiq</div>
                        <div class="stat-value" id="st-qoldiq">0</div>
                    </div>
                </div>

                <div class="filter-bar">
                    <input id="search-input" placeholder="Qidirish: Ism yoki Telefon..." oninput="renderClients()">
                    <select id="filter-state" onchange="renderClients()">
                        <option value="all">Barchasi</option>
                        <option value="debt">Qarzdorlar</option>
                        <option value="clean">Qarzi yo'qlar</option>
                    </select>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ism familiya</th>
                                    <th>Telefon</th>
                                    <th>Berilgan tovar</th>
                                    <th>Jami Summa</th>
                                    <th>To'langan</th>
                                    <th>Qoldiq</th>
                                    <th style="text-align: right">Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-mijozlar"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-omborxona" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Omborxona</h1>
                    <button class="btn btn-primary" onclick="openProductModal()">
                        <i data-feather="plus"></i> Mahsulot qo'shish
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Ombor Qiymati (Taxminiy)</div>
                        <div class="stat-value" id="st-ombor-total">0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nomi</th>
                                    <th>Birlik</th>
                                    <th>Qoldiq</th>
                                    <th>Kelish narxi</th>
                                    <th style="text-align: right">Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-ombor"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-harajatlar" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Harajatlar</h1>
                    <button class="btn btn-primary" onclick="openExpenseModal()">
                        <i data-feather="plus"></i> Harajat qo'shish
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Jami Harajat</div>
                        <div class="stat-value" id="st-harajat-total">0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sana</th>
                                    <th>Sabab</th>
                                    <th>Summa</th>
                                    <th style="text-align: right">Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-harajat"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-statistika" class="view-section">
                <div class="page-header">
                    <h1 class="page-title">Statistika</h1>
                </div>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="stat-card">
                        <canvas id="chartPie"></canvas>
                    </div>
                    <div class="stat-card">
                        <canvas id="chartBar"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <dialog id="dlgClient">
        <div class="modal-header">
            <span class="modal-title" id="dlgClientTitle">Mijoz</span>
            <button class="close-modal-btn" onclick="dlgClient.close()"><i data-feather="x"></i></button>
        </div>
        <form id="formClient">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="full-width">
                        <label class="stat-label">Ism Familiya</label>
                        <input id="c_name" required placeholder="To'liq ism">
                    </div>
                    <div>
                        <label class="stat-label">Telefon</label>
                        <input id="c_phone" placeholder="+998...">
                    </div>
                    <div>
                        <label class="stat-label">Boshlang'ich qarz (agar bo'lsa)</label>
                        <input id="c_init_debt" type="number" value="0">
                    </div>
                    <div>
                        <label class="stat-label">Narx (1 dona uchun)</label>
                        <input id="c_price_dona" type="number" placeholder="So'm">
                    </div>
                    <div>
                        <label class="stat-label">Narx (1 sm uchun)</label>
                        <input id="c_price_sm" type="number" placeholder="So'm">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="dlgClient.close()">Bekor qilish</button>
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgHistory">
        <div class="modal-header">
            <span class="modal-title"><span id="histClientName"></span> - Tarix</span>
            <button class="close-modal-btn" onclick="dlgHistory.close()"><i data-feather="x"></i></button>
        </div>
        <div class="modal-body" style="background: var(--hover-bg);">
            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px; color: var(--text-titles)">Yangi savdo / Tovar berish</h4>
                <form id="formTrade" class="form-grid">
                    <div class="full-width">
                        <select id="t_prod_select" style="border-color: var(--primary); font-weight: bold;">
                            <option value="">-- Omborxonadan tanlash (Ixtiyoriy) --</option>
                        </select>
                    </div>
                    <div>
                        <input id="t_date" type="date" required>
                    </div>
                    <div>
                        <input id="t_qty_dona" type="number" step="any" placeholder="Dona">
                    </div>
                    <div>
                        <input id="t_len_sm" type="number" step="any" placeholder="Sm">
                    </div>
                    <div>
                        <input id="t_price_dona" type="number" placeholder="Narx/dona (Avto)">
                    </div>
                    <div>
                        <input id="t_price_sm" type="number" placeholder="Narx/sm (Avto)">
                    </div>
                    <div class="full-width">
                        <input id="t_note" placeholder="Izoh...">
                    </div>
                    <div class="full-width" style="text-align: right;">
                        <button class="btn btn-primary">Qo'shish</button>
                    </div>
                </form>
            </div>

            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                <h4 style="margin-bottom: 10px; color: var(--text-titles)">To'lov qabul qilish</h4>
                <form id="formPayment" style="display: flex; gap: 10px;">
                    <input id="p_date" type="date" required>
                    <input id="p_amount" type="number" placeholder="Summa" required style="flex-grow:1">
                    <button class="btn btn-primary">Saqlash</button>
                </form>
            </div>

            <div class="card" style="margin-bottom: 0;">
                <table>
                    <thead>
                        <tr>
                            <th>Sana</th>
                            <th>Tovar / Izoh</th>
                            <th>Miqdor</th>
                            <th>Jami</th>
                            <th>To'lov</th>
                            <th>Amal</th>
                        </tr>
                    </thead>
                    <tbody id="tbody-history"></tbody>
                </table>
            </div>
        </div>
    </dialog>

    <dialog id="dlgProduct">
        <div class="modal-header">
            <span class="modal-title">Mahsulot</span>
            <button class="close-modal-btn" onclick="dlgProduct.close()"><i data-feather="x"></i></button>
        </div>
        <form id="formProduct">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="full-width">
                        <label class="stat-label">Nomi</label>
                        <input id="w_name" required>
                    </div>
                    <div>
                        <label class="stat-label">Birlik</label>
                        <select id="w_unit">
                            <option value="dona">Dona</option>
                            <option value="sm">Sm</option>
                        </select>
                    </div>
                    <div>
                        <label class="stat-label">Qoldiq</label>
                        <input id="w_qty" type="number" required>
                    </div>
                    <div class="full-width">
                        <label class="stat-label">Kelish narxi (so'm)</label>
                        <input id="w_price" type="number">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgExpense">
        <div class="modal-header">
            <span class="modal-title">Harajat</span>
            <button class="close-modal-btn" onclick="dlgExpense.close()"><i data-feather="x"></i></button>
        </div>
        <form id="formExpense">
            <div class="modal-body">
                <div class="form-grid">
                    <div>
                        <label class="stat-label">Sana</label>
                        <input id="e_date" type="date" required>
                    </div>
                    <div>
                        <label class="stat-label">Summa</label>
                        <input id="e_amount" type="number" required>
                    </div>
                    <div class="full-width">
                        <label class="stat-label">Sabab</label>
                        <input id="e_reason" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <script>
        // === UTILS ===
        const $ = id => document.getElementById(id);
        const fmt = n => Number(n||0).toLocaleString('uz-UZ');
        const parse = n => parseFloat(n) || 0;
        const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('uz-UZ');

        // === DATA STORE (LocalStorage) ===
        const DB = {
            clients: JSON.parse(localStorage.getItem('blink_clients') || '[]'),
            warehouse: JSON.parse(localStorage.getItem('blink_warehouse') || '[]'),
            expenses: JSON.parse(localStorage.getItem('blink_expenses') || '[]'),

            save: () => {
                localStorage.setItem('blink_clients', JSON.stringify(DB.clients));
                localStorage.setItem('blink_warehouse', JSON.stringify(DB.warehouse));
                localStorage.setItem('blink_expenses', JSON.stringify(DB.expenses));
                refreshAll();
            }
        };

        let currIdx = null; // Hozirgi tanlangan mijoz indexi

        // === NAVIGATSIYA ===
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            $(`view-${tab}`).classList.add('active');
            $(`nav-${tab}`).classList.add('active');
            
            // Mobil sidebar yopish
            $('sidebar').classList.remove('show');

            if(tab === 'statistika') renderCharts();
        }
        function toggleSidebar() { $('sidebar').classList.toggle('show'); }

        // === 1. MIJOZLAR LOGIKASI ===
        function getClientTotals(c) {
            let debt = parse(c.init_debt || 0); // Boshlang'ich qarz
            let prodTotal = 0;
            
            // Tarix bo'yicha hisoblash
            (c.history || []).forEach(h => {
                if(h.type === 'trade') {
                    const cost = (parse(h.qty_dona) * parse(h.price_dona)) + (parse(h.len_sm) * parse(h.price_sm));
                    debt += cost;
                    prodTotal += cost;
                } else if(h.type === 'pay') {
                    debt -= parse(h.amount);
                }
            });

            // Qaytgan umumiy summa = Jami qarz (historysiz) - Hozirgi qarz ??
            // Oddiyroq: Jami savdo - Hozirgi qoldiq = To'langan (agar init debt 0 bo'lsa)
            // Keling, aniqroq hisoblaymiz:
            let totalPaid = (c.history || []).filter(h => h.type === 'pay').reduce((s, h) => s + parse(h.amount), 0);
            
            return { debt, paid: totalPaid, totalTrade: prodTotal + parse(c.init_debt || 0) };
        }

        function renderClients() {
            const tbody = $('tbody-mijozlar');
            tbody.innerHTML = '';
            
            const search = $('search-input').value.toLowerCase();
            const filter = $('filter-state').value;

            let grandDebt = 0, grandPaid = 0;

            DB.clients.forEach((c, i) => {
                const t = getClientTotals(c);
                const matchSearch = c.name.toLowerCase().includes(search) || (c.phone||'').includes(search);
                const matchFilter = filter === 'all' || (filter === 'debt' && t.debt > 0) || (filter === 'clean' && t.debt <= 0);

                if(matchSearch && matchFilter) {
                    grandDebt += t.debt;
                    grandPaid += t.paid;

                    const tr = document.createElement('tr');
                    if(t.debt > 0) tr.classList.add('warn-row');
                    
                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td><div style="font-weight:600">${c.name}</div></td>
                        <td>${c.phone || '-'}</td>
                        <td>${fmt(t.totalTrade)}</td>
                        <td style="font-weight:bold">${fmt(t.totalTrade)}</td>
                        <td style="color:var(--primary)">${fmt(t.paid)}</td>
                        <td style="color:var(--danger); font-weight:bold">${fmt(t.debt)}</td>
                        <td>
                            <div class="actions">
                                <button class="icon-btn edit" onclick="openHistory(${i})" title="Tarix va Savdo"><i data-feather="shopping-cart"></i></button>
                                <button class="icon-btn edit" onclick="editClient(${i})" title="Tahrirlash"><i data-feather="edit-2"></i></button>
                                <button class="icon-btn delete" onclick="delClient(${i})" title="O'chirish"><i data-feather="trash-2"></i></button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });

            $('st-qarz').innerText = fmt(grandDebt);
            $('st-tolov').innerText = fmt(grandPaid);
            $('st-qoldiq').innerText = fmt(grandDebt); // Qoldiq qarz bilan bir xil mantiqda
            feather.replace();
        }

        // Mijoz Modal
        function openClientModal() {
            currIdx = null;
            $('formClient').reset();
            $('dlgClientTitle').innerText = "Yangi Mijoz";
            $('dlgClient').showModal();
        }
        function editClient(i) {
            currIdx = i;
            const c = DB.clients[i];
            $('c_name').value = c.name;
            $('c_phone').value = c.phone;
            $('c_init_debt').value = c.init_debt || 0;
            $('c_price_dona').value = c.def_price_dona || '';
            $('c_price_sm').value = c.def_price_sm || '';
            $('dlgClientTitle').innerText = "Tahrirlash";
            $('dlgClient').showModal();
        }
        $('formClient').onsubmit = e => {
            e.preventDefault();
            const client = {
                name: $('c_name').value,
                phone: $('c_phone').value,
                init_debt: parse($('c_init_debt').value),
                def_price_dona: parse($('c_price_dona').value),
                def_price_sm: parse($('c_price_sm').value),
                history: currIdx !== null ? DB.clients[currIdx].history : []
            };
            if(currIdx !== null) DB.clients[currIdx] = client;
            else DB.clients.push(client);
            
            DB.save();
            $('dlgClient').close();
        };
        function delClient(i) {
            if(confirm("Mijoz o'chirilsinmi?")) {
                DB.clients.splice(i, 1);
                DB.save();
            }
        }

        // === 2. TARIX VA SAVDO LOGIKASI ===
        function openHistory(i) {
            currIdx = i;
            const c = DB.clients[i];
            $('histClientName').innerText = c.name;
            
            // Savdo formasi uchun defaultlar
            $('formTrade').reset();
            $('t_date').valueAsDate = new Date();
            $('t_price_dona').value = c.def_price_dona || '';
            $('t_price_sm').value = c.def_price_sm || '';
            
            // To'lov formasi
            $('formPayment').reset();
            $('p_date').valueAsDate = new Date();

            // Omborni yuklash selectga
            const sel = $('t_prod_select');
            sel.innerHTML = '<option value="">-- Omborxonadan tanlash (Ixtiyoriy) --</option>';
            DB.warehouse.forEach(w => {
                const opt = document.createElement('option');
                opt.value = w.id;
                opt.text = `${w.name} | Qoldiq: ${w.qty} ${w.unit}`;
                sel.add(opt);
            });
            // Select o'zgarganda narxlarni va bloklarni to'g'irlash
            sel.onchange = function() {
                const w = DB.warehouse.find(x => x.id == this.value);
                if(w) {
                    if(w.unit === 'dona') { $('t_qty_dona').disabled = false; $('t_len_sm').disabled = true; $('t_len_sm').value = ''; }
                    else { $('t_len_sm').disabled = false; $('t_qty_dona').disabled = true; $('t_qty_dona').value = ''; }
                    // Narxni ham qo'yib yuboramiz agar bor bo'lsa
                    if(w.price) {
                        if(w.unit === 'dona') $('t_price_dona').value = w.price;
                        else $('t_price_sm').value = w.price;
                    }
                } else {
                    $('t_qty_dona').disabled = false; $('t_len_sm').disabled = false;
                }
            };

            renderHistoryTable();
            $('dlgHistory').showModal();
        }

        function renderHistoryTable() {
            const tbody = $('tbody-history');
            tbody.innerHTML = '';
            const c = DB.clients[currIdx];
            
            // Tarixni teskari tartibda (yangi tepada)
            const list = (c.history || []).map((h, idx) => ({...h, idx})).reverse();

            list.forEach(h => {
                const tr = document.createElement('tr');
                let desc = h.note || '-';
                // Agar ombordan bo'lsa
                if(h.prodId) {
                    const w = DB.warehouse.find(x => x.id === h.prodId);
                    if(w) desc = `<span style="color:var(--primary); font-weight:bold">${w.name}</span> ` + desc;
                }

                if(h.type === 'trade') {
                    const total = (parse(h.qty_dona)*parse(h.price_dona)) + (parse(h.len_sm)*parse(h.price_sm));
                    const qtyStr = (h.qty_dona ? h.qty_dona+' dona ' : '') + (h.len_sm ? h.len_sm+' sm' : '');
                    
                    tr.innerHTML = `
                        <td>${h.date}</td>
                        <td>${desc}</td>
                        <td>${qtyStr}</td>
                        <td style="font-weight:bold">${fmt(total)}</td>
                        <td>-</td>
                        <td><button class="icon-btn delete" onclick="delHistoryItem(${h.idx})"><i data-feather="x"></i></button></td>
                    `;
                } else {
                    tr.innerHTML = `
                        <td>${h.date}</td>
                        <td>To'lov: ${h.note || ''}</td>
                        <td>-</td>
                        <td>-</td>
                        <td style="color:var(--primary); font-weight:bold">${fmt(h.amount)}</td>
                        <td><button class="icon-btn delete" onclick="delHistoryItem(${h.idx})"><i data-feather="x"></i></button></td>
                    `;
                }
                tbody.appendChild(tr);
            });
            feather.replace();
        }

        // Savdo qo'shish
        $('formTrade').onsubmit = e => {
            e.preventDefault();
            const prodId = $('t_prod_select').value;
            const qD = parse($('t_qty_dona').value);
            const qS = parse($('t_len_sm').value);
            
            // Ombordan ayirish
            if(prodId) {
                const w = DB.warehouse.find(x => x.id === prodId);
                const needed = w.unit === 'dona' ? qD : qS;
                if(w.qty < needed) { alert("Omborda yetarli emas!"); return; }
                w.qty -= needed;
            }

            const rec = {
                type: 'trade',
                date: $('t_date').value,
                qty_dona: qD, len_sm: qS,
                price_dona: parse($('t_price_dona').value),
                price_sm: parse($('t_price_sm').value),
                note: $('t_note').value,
                prodId: prodId || null
            };

            if(!DB.clients[currIdx].history) DB.clients[currIdx].history = [];
            DB.clients[currIdx].history.push(rec);
            DB.save();
            
            // Reset form partly
            $('t_qty_dona').value=''; $('t_len_sm').value=''; $('t_note').value='';
            // Qayta chizish
            openHistory(currIdx);
        };

        // To'lov qo'shish
        $('formPayment').onsubmit = e => {
            e.preventDefault();
            const rec = {
                type: 'pay',
                date: $('p_date').value,
                amount: parse($('p_amount').value),
                note: 'Karta/Naqd'
            };
            if(!DB.clients[currIdx].history) DB.clients[currIdx].history = [];
            DB.clients[currIdx].history.push(rec);
            DB.save();
            $('p_amount').value = '';
            renderHistoryTable();
        };

        // Tarixni o'chirish (Omborga qaytarish bilan)
        function delHistoryItem(realIdx) {
            if(!confirm("O'chirilsinmi?")) return;
            const c = DB.clients[currIdx];
            const h = c.history[realIdx];

            if(h.type === 'trade' && h.prodId) {
                const w = DB.warehouse.find(x => x.id === h.prodId);
                if(w) w.qty += (w.unit === 'dona' ? parse(h.qty_dona) : parse(h.len_sm));
            }
            c.history.splice(realIdx, 1);
            DB.save();
            renderHistoryTable();
        }

        // === 3. OMBORXONA LOGIKASI ===
        function renderWarehouse() {
            const tbody = $('tbody-ombor');
            tbody.innerHTML = '';
            let totalVal = 0;

            DB.warehouse.forEach((w, i) => {
                const val = w.qty * (w.price || 0);
                totalVal += val;
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="font-weight:600">${w.name}</td>
                    <td><span style="background:var(--hover-bg); color:var(--primary); padding:2px 8px; border-radius:4px; font-size:12px">${w.unit}</span></td>
                    <td style="font-weight:bold">${fmt(w.qty)}</td>
                    <td>${fmt(w.price)}</td>
                    <td>
                         <button class="icon-btn delete" onclick="delProduct(${i})"><i data-feather="trash-2"></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            $('st-ombor-total').innerText = fmt(totalVal);
            feather.replace();
        }

        function openProductModal() { $('formProduct').reset(); $('dlgProduct').showModal(); }
        $('formProduct').onsubmit = e => {
            e.preventDefault();
            DB.warehouse.push({
                id: genId(),
                name: $('w_name').value,
                unit: $('w_unit').value,
                qty: parse($('w_qty').value),
                price: parse($('w_price').value)
            });
            DB.save();
            $('dlgProduct').close();
        };
        function delProduct(i) {
            if(confirm("Mahsulot o'chirilsinmi?")) { DB.warehouse.splice(i,1); DB.save(); }
        }

        // === 4. HARAJATLAR ===
        function renderExpenses() {
            const tbody = $('tbody-harajat');
            tbody.innerHTML = '';
            let total = 0;
            
            DB.expenses.slice().reverse().forEach((e, i) => { // Yangisi tepada
                total += parse(e.amount);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.reason}</td>
                    <td style="color:var(--danger); font-weight:bold">-${fmt(e.amount)}</td>
                    <td><button class="icon-btn delete" onclick="delExpense(${DB.expenses.length - 1 - i})"><i data-feather="trash-2"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
            $('st-harajat-total').innerText = fmt(total);
            feather.replace();
        }

        function openExpenseModal() { $('formExpense').reset(); $('e_date').valueAsDate = new Date(); $('dlgExpense').showModal(); }
        $('formExpense').onsubmit = e => {
            e.preventDefault();
            DB.expenses.push({
                date: $('e_date').value,
                reason: $('e_reason').value,
                amount: parse($('e_amount').value)
            });
            DB.save();
            $('dlgExpense').close();
        };
        function delExpense(realIdx) {
            if(confirm("O'chirilsinmi?")) { DB.expenses.splice(realIdx, 1); DB.save(); }
        }

        // === 5. DIAGRAMMALAR (Chart.js) ===
        function renderCharts() {
            // Data prep
            const ctxPie = $('chartPie');
            const ctxBar = $('chartBar');
            
            // Top qarzdorlar
            const debtors = DB.clients.map(c => ({name: c.name, debt: getClientTotals(c).debt}))
                                      .filter(x => x.debt > 0)
                                      .sort((a,b) => b.debt - a.debt)
                                      .slice(0, 5);
            
            // Oylik harajat vs tushum (demo uchun oddiy)
            const expenseTotal = DB.expenses.reduce((s, e) => s + parse(e.amount), 0);
            const incomeTotal = DB.clients.reduce((s, c) => s + getClientTotals(c).paid, 0);

            if(window.myPie) window.myPie.destroy();
            window.myPie = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: debtors.map(d => d.name),
                    datasets: [{
                        data: debtors.map(d => d.debt),
                        backgroundColor: ['#702C2B', '#C56869', '#DB9F95', '#A04040', '#E08080']
                    }]
                },
                options: { plugins: { title: { display: true, text: 'Top 5 Qarzdorlar', color: '#702C2B' } } }
            });

            if(window.myBar) window.myBar.destroy();
            window.myBar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Tushum', 'Harajat'],
                    datasets: [{
                        label: "So'm",
                        data: [incomeTotal, expenseTotal],
                        backgroundColor: ['#702C2B', '#C56869']
                    }]
                },
                options: { 
                    plugins: { title: { display: true, text: 'Umumiy balans', color: '#702C2B' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // === EXCEL EXPORT ===
        function exportExcel() {
            const wb = XLSX.utils.book_new();
            
            // Mijozlar
            const cData = DB.clients.map(c => {
                const t = getClientTotals(c);
                return { "Ism": c.name, "Telefon": c.phone, "Jami Savdo": t.totalTrade, "To'langan": t.paid, "Qarz": t.debt };
            });
            const ws1 = XLSX.utils.json_to_sheet(cData);
            XLSX.utils.book_append_sheet(wb, ws1, "Mijozlar");

            // Ombor
            const ws2 = XLSX.utils.json_to_sheet(DB.warehouse);
            XLSX.utils.book_append_sheet(wb, ws2, "Omborxona");

            XLSX.writeFile(wb, "Hisobot.xlsx");
        }

        // === INIT ===
        function refreshAll() {
            renderClients();
            renderWarehouse();
            renderExpenses();
        }
        
        refreshAll();
        feather.replace();

    </script>
</body>
</html>
