Tushunarli. Siz yuborgan rasm ("Color Palette -06")dagi yashil ranglar palitrasiga o'tamiz va eng asosiysi — Dialog (Modal) oynalarning chap tarafda qolib ketish muammosini hal qilamiz.
Tuzatishlar:
 * O‘rtaga olish: dialog elementiga margin: auto va inset: 0 berib, ekran o‘rtasiga aniq joylashtirdim.
 * Yangi Ranglar (Palette -06):
   * Asosiy rang: #337B01 (Tabiiy yashil)
   * To‘q rang: #2F5233 (Hover va sarlavhalar)
   * Och rang: #BEEAC5 (Hoshiya va fon elementlari)
   * Orqa fon: OQ (#FFFFFF).
Marhamat, to‘liq va tuzatilgan kod:
<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qarz Tizimi - Green Dashboard</title>
    
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        /* ============== 1. UMUMIY DIZAYN & PALITRA (Palette -06) ============== */
        :root {
            /* --- YANGI YASHIL PALITRA --- */
            --col-deep-green: #2F5233; /* Eng to'q yashil */
            --col-main-green: #337B01; /* Asosiy yashil (Primary) */
            --col-soft-green: #76B947; /* Yumshoq yashil (Secondary) */
            --col-pale-green: #BEEAC5; /* Juda och yashil (Light bg) */
            
            /* --- TIZIM RANGLARI --- */
            --primary: var(--col-main-green);
            --primary-hover: var(--col-deep-green);
            --bg-body: #ffffff;        /* FON OQ */
            --bg-sidebar: #ffffff;     
            --text-main: #2D2D2D;      
            --text-muted: #6b7280;     
            --border: var(--col-pale-green); /* Hoshiyalar och yashil */
            
            --danger: #ef4444;         
            --sidebar-width: 260px;
            --radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: var(--bg-body);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-main);
        }

        /* ============== 2. SIDEBAR (Chap menyu) ============== */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 24px;
            flex-shrink: 0;
        }

        .brand {
            color: var(--primary);
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 35px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 10px;
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: var(--radius);
            color: var(--text-muted);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            font-size: 15px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .nav-item:hover {
            background-color: var(--col-pale-green); 
            color: var(--col-deep-green);
        }

        .nav-item.active {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(51, 123, 1, 0.3); /* Yashil soya */
        }

        .nav-item i { width: 20px; height: 20px; }

        .logout-btn {
            margin-top: auto;
            border: 1px solid var(--border);
            color: var(--primary);
            justify-content: center;
        }
        .logout-btn:hover {
            background: var(--col-pale-green);
        }

        /* ============== 3. ASOSIY QISM (Main) ============== */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-body);
        }

        .top-header {
            background-color: #ffffff;
            height: 64px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 32px;
            justify-content: space-between;
        }

        .page-header-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--col-deep-green);
        }

        .content-area {
            padding: 32px;
            overflow-y: auto;
            height: 100%;
        }

        /* ============== 4. UI ELEMENTLARI ============== */
        /* Tugmalar */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius);
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: 0.2s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 5px rgba(51, 123, 1, 0.2);
        }
        .btn-primary:hover { background-color: var(--primary-hover); }

        .btn-outline {
            background: white;
            border: 1px solid var(--border);
            color: var(--text-main);
        }
        .btn-outline:hover { background: var(--col-pale-green); border-color: var(--primary); }

        /* Filterlar */
        .filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            outline: none;
            font-size: 14px;
            background: #fff;
            color: var(--text-main);
        }
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(51, 123, 1, 0.1);
        }

        /* Jadvallar (Card Style) */
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .table-responsive { width: 100%; overflow-x: auto; }

        table { width: 100%; border-collapse: collapse; min-width: 800px; }

        th {
            text-align: left;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            color: var(--col-deep-green);
            font-weight: 700;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: #f0fdf4; /* Juda och yashil fon */
        }

        td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
            font-size: 14px;
            vertical-align: middle;
        }

        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: #f9fff9; }
        
        tr.warn-row td { background-color: rgba(239, 68, 68, 0.05); }

        /* Amallar tugmalari */
        .icon-btn {
            background: none;
            border: 1px solid transparent;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: .2s;
            color: var(--col-soft-green);
        }
        .icon-btn:hover { background: var(--col-pale-green); color: var(--primary); }
        .icon-btn.delete { color: var(--danger); }
        .icon-btn.delete:hover { background: #fee2e2; }

        /* Statistika Kartalari */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .stat-label { font-size: 13px; color: var(--text-muted); margin-bottom: 8px; font-weight: 600; text-transform: uppercase; }
        .stat-value { font-size: 26px; font-weight: 800; color: var(--primary); }

        /* ================== DIALOG (MODAL) TUZATILDI ================== */
        dialog {
            /* O'rtaga joylashtirish sirlari: */
            position: fixed; 
            inset: 0;        /* 4 tarafdan yopishish */
            margin: auto;    /* Avtomatik o'rtaga olish */
            z-index: 9999;
            
            border: none;
            border-radius: 12px;
            width: 90%;      /* Mobil moslashuv */
            max-width: 550px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 0;
            background: #fff;
        }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }
        .modal-title { font-weight: 700; font-size: 18px; color: var(--col-deep-green); }
        .modal-body { padding: 24px; display: grid; gap: 16px; background: #fff; }
        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            background: #fdfdfd;
        }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }

        /* Rasmlar (Omborxona) */
        .product-img {
            width: 40px; height: 40px; border-radius: 6px; 
            object-fit: cover; border: 1px solid var(--border);
        }

        /* Views */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; z-index: 100; transition: 0.3s; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
            .sidebar.show { left: 0; }
            .top-header { padding: 0 16px; }
            .content-area { padding: 16px; }
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>

    <aside class="sidebar" id="sidebar">
        <div class="brand">
            <i data-feather="briefcase"></i> Qarz Tizimi
        </div>
        <nav class="nav-menu">
            <button onclick="switchTab('mijozlar')" class="nav-item active" id="nav-mijozlar">
                <i data-feather="users"></i> Mijozlar
            </button>
            <button onclick="switchTab('omborxona')" class="nav-item" id="nav-omborxona">
                <i data-feather="box"></i> Omborxona
            </button>
            <button onclick="switchTab('harajatlar')" class="nav-item" id="nav-harajatlar">
                <i data-feather="trending-down"></i> Harajatlar
            </button>
            <button onclick="switchTab('statistika')" class="nav-item" id="nav-statistika">
                <i data-feather="pie-chart"></i> Statistika
            </button>
            
            <button onclick="exportExcel()" class="nav-item logout-btn">
                <i data-feather="download"></i> Excelga Yuklash
            </button>
        </nav>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <div style="display:flex; align-items:center; gap:15px">
                <button class="btn-outline" onclick="toggleSidebar()" style="padding:8px; border-radius:50%; display:none; @media(max-width:768px){display:block}">
                    <i data-feather="menu"></i>
                </button>
                <span class="page-header-title" id="page-title">Mijozlar</span>
            </div>
            <div style="font-size:14px; color:var(--primary); font-weight:500;">
                <i data-feather="calendar" style="width:14px; vertical-align:middle"></i> 
                <span id="current-date"></span>
            </div>
        </header>

        <div class="content-area">

            <div id="view-mijozlar" class="view-section active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:10px;">
                    <div class="filter-bar" style="margin-bottom:0; flex-grow:1; max-width:500px;">
                        <input id="search-client" class="form-control" placeholder="Qidirish: Ism yoki Telefon..." oninput="renderClients()">
                        <select id="filter-state" class="form-control" onchange="renderClients()" style="width:150px;">
                            <option value="all">Barchasi</option>
                            <option value="debt">Qarzdorlar</option>
                            <option value="clean">Toza</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('dlgClient')">
                        <i data-feather="plus"></i> Yangi Mijoz
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Umumiy Qarz</div>
                        <div class="stat-value" id="st-debt" style="color:var(--danger)">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">To'langan</div>
                        <div class="stat-value" id="st-paid" style="color:var(--primary)">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Umumiy Savdo</div>
                        <div class="stat-value" id="st-trade" style="color:var(--text-main)">0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ism Familiya</th>
                                    <th>Telefon</th>
                                    <th>Jami Savdo</th>
                                    <th>To'langan</th>
                                    <th>Qarz</th>
                                    <th style="text-align: right">Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-clients"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-omborxona" class="view-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:24px">
                    <h2 style="color:var(--primary)">Omborxona</h2>
                    <button class="btn btn-primary" onclick="openModal('dlgProduct')">
                        <i data-feather="plus"></i> Mahsulot Qo'shish
                    </button>
                </div>
                
                <div class="card">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Rasm</th>
                                    <th>Nomi</th>
                                    <th>Birlik</th>
                                    <th>Qoldiq</th>
                                    <th>Sotish Narxi</th>
                                    <th style="text-align: right">Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-warehouse"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-harajatlar" class="view-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:24px">
                    <h2 style="color:var(--primary)">Harajatlar</h2>
                    <button class="btn btn-primary" onclick="openModal('dlgExpense')">
                        <i data-feather="minus-circle"></i> Harajat Qo'shish
                    </button>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Jami Harajat</div>
                        <div class="stat-value" id="st-exp-total">0</div>
                    </div>
                </div>

                <div class="card">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Sana</th>
                                    <th>Sabab</th>
                                    <th>Summa</th>
                                    <th style="text-align: right">Amallar</th>
                                </tr>
                            </thead>
                            <tbody id="tbody-expenses"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-statistika" class="view-section">
                <h2 style="color:var(--primary); margin-bottom:24px;">Umumiy Hisobot</h2>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="stat-card">
                        <canvas id="chartPie"></canvas>
                    </div>
                    <div class="stat-card">
                        <canvas id="chartBar"></canvas>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <dialog id="dlgClient">
        <div class="modal-header">
            <span class="modal-title">Yangi Mijoz</span>
            <button onclick="closeModal('dlgClient')" style="border:none; background:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <form onsubmit="saveClient(event)">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="full-width">
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Ism Familiya</label>
                        <input id="c_name" class="form-control" required placeholder="F.I.O">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Telefon</label>
                        <input id="c_phone" class="form-control" placeholder="+998...">
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Eski Qarz</label>
                        <input id="c_init" type="number" class="form-control" value="0">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('dlgClient')">Bekor qilish</button>
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgProduct">
        <div class="modal-header">
            <span class="modal-title">Yangi Mahsulot</span>
            <button onclick="closeModal('dlgProduct')" style="border:none; background:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <form onsubmit="saveProduct(event)">
            <div class="modal-body">
                <div class="form-grid">
                    <div class="full-width">
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Mahsulot Rasmi</label>
                        <input type="file" id="w_img_file" class="form-control" accept="image/*">
                    </div>
                    <div class="full-width">
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Nomi</label>
                        <input id="w_name" class="form-control" required>
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Birlik</label>
                        <select id="w_unit" class="form-control">
                            <option value="dona">Dona</option>
                            <option value="kg">Kg</option>
                            <option value="metr">Metr</option>
                            <option value="litr">Litr</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Qoldiq</label>
                        <input id="w_qty" type="number" class="form-control" required>
                    </div>
                    <div class="full-width">
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Sotish Narxi</label>
                        <input id="w_price" type="number" class="form-control">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('dlgProduct')">Bekor qilish</button>
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgExpense">
        <div class="modal-header">
            <span class="modal-title">Harajat</span>
            <button onclick="closeModal('dlgExpense')" style="border:none; background:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <form onsubmit="saveExpense(event)">
            <div class="modal-body">
                <div class="form-grid">
                    <div>
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Sana</label>
                        <input id="e_date" type="date" class="form-control" required>
                    </div>
                    <div>
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Summa</label>
                        <input id="e_amount" type="number" class="form-control" required>
                    </div>
                    <div class="full-width">
                        <label style="font-size:12px; font-weight:600; color:var(--primary)">Sabab</label>
                        <input id="e_reason" class="form-control" required>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('dlgExpense')">Bekor qilish</button>
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgHistory" style="max-width: 800px;">
        <div class="modal-header">
            <span class="modal-title"><span id="histClientName"></span> — Tarix</span>
            <button onclick="closeModal('dlgHistory')" style="border:none; background:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <div class="modal-body" style="background: #fcfcfc;">
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div style="background:white; padding:20px; border-radius:12px; border:1px solid var(--border)">
                    <h4 style="margin-bottom:15px; color:var(--primary); display:flex; align-items:center; gap:8px"><i data-feather="shopping-cart" style="width:16px"></i> Tovar berish</h4>
                    <form onsubmit="addTrade(event)" style="display:grid; gap:10px">
                        <select id="t_prod" class="form-control" onchange="autoFillPrice()">
                            <option value="">-- Ombordan tanlash --</option>
                        </select>
                        <div style="display:flex; gap:10px">
                            <input id="t_qty" type="number" class="form-control" placeholder="Miqdor" required>
                            <input id="t_price" type="number" class="form-control" placeholder="Narx">
                        </div>
                        <input id="t_note" class="form-control" placeholder="Izoh (agar kerak bo'lsa)">
                        <button class="btn btn-primary" style="width:100%">Qo'shish</button>
                    </form>
                </div>

                <div style="background:white; padding:20px; border-radius:12px; border:1px solid var(--border)">
                    <h4 style="margin-bottom:15px; color:var(--primary); display:flex; align-items:center; gap:8px"><i data-feather="credit-card" style="width:16px"></i> To'lov qabul qilish</h4>
                    <form onsubmit="addPayment(event)" style="display:grid; gap:10px">
                        <select id="p_method" class="form-control">
                            <option value="cash">Naqd</option>
                            <option value="card">Plastik Karta</option>
                            <option value="click">Click / Payme</option>
                        </select>
                        <input id="p_amount" type="number" class="form-control" placeholder="Summa" required>
                        <button class="btn btn-primary" style="width:100%">To'lovni Saqlash</button>
                    </form>
                </div>
            </div>

            <div class="card" style="margin-bottom: 0; margin-top:20px; border:none; box-shadow:none;">
                <div class="table-responsive" style="max-height: 300px;">
                    <table>
                        <thead>
                            <tr>
                                <th>Sana</th>
                                <th>Ma'lumot</th>
                                <th>Kirim / Chiqim</th>
                                <th style="text-align:right">Amal</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-history"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </dialog>

    <script>
        // === UTILS ===
        const $ = id => document.getElementById(id);
        const fmt = n => Number(n).toLocaleString('uz-UZ');
        const parse = n => parseFloat(n) || 0;
        const genId = () => Math.random().toString(36).substr(2,9);
        $('current-date').innerText = new Date().toLocaleDateString('uz-UZ', {weekday:'long', year:'numeric', month:'long', day:'numeric'});

        // === DATABASE ===
        const DB = {
            clients: JSON.parse(localStorage.getItem('bp_clients') || '[]'),
            warehouse: JSON.parse(localStorage.getItem('bp_warehouse') || '[]'),
            expenses: JSON.parse(localStorage.getItem('bp_expenses') || '[]'),
            save: () => {
                localStorage.setItem('bp_clients', JSON.stringify(DB.clients));
                localStorage.setItem('bp_warehouse', JSON.stringify(DB.warehouse));
                localStorage.setItem('bp_expenses', JSON.stringify(DB.expenses));
                refreshAll();
            }
        };
        let currClientIdx = null;

        // === NAVIGATION ===
        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            $(`view-${tab}`).classList.add('active');
            $(`nav-${tab}`).classList.add('active');
            $('page-title').innerText = tab.charAt(0).toUpperCase() + tab.slice(1);
            if(tab === 'statistika') renderCharts();
        }
        function toggleSidebar() { $('sidebar').classList.toggle('show'); }

        // === MIJOZLAR ===
        function renderClients() {
            const tbody = $('tbody-clients'); tbody.innerHTML = '';
            const search = $('search-client').value.toLowerCase();
            const filter = $('filter-state').value;
            let totDebt = 0, totPaid = 0, totTrade = 0;

            DB.clients.forEach((c, i) => {
                let debt = parse(c.init || 0);
                let paid = 0;
                let trade = 0;

                (c.history || []).forEach(h => {
                    if(h.type === 'trade') { 
                        let cost = parse(h.qty) * parse(h.price); 
                        debt += cost; trade += cost;
                    } else { 
                        debt -= parse(h.amount); paid += parse(h.amount);
                    }
                });

                if(c.name.toLowerCase().includes(search)) {
                    if(filter === 'debt' && debt <= 0) return;
                    if(filter === 'clean' && debt > 0) return;

                    totDebt += debt; totPaid += paid; totTrade += trade;
                    
                    const tr = document.createElement('tr');
                    if(debt > 0) tr.classList.add('warn-row');
                    
                    tr.innerHTML = `
                        <td>${i + 1}</td>
                        <td><div style="font-weight:700; color:var(--primary)">${c.name}</div></td>
                        <td>${c.phone || '-'}</td>
                        <td>${fmt(trade)}</td>
                        <td style="color:var(--primary)">${fmt(paid)}</td>
                        <td style="color:var(--danger); font-weight:800">${fmt(debt)}</td>
                        <td style="text-align:right">
                            <button class="icon-btn edit" onclick="openHistory(${i})" title="Tarix"><i data-feather="shopping-cart" style="width:16px"></i></button>
                            <button class="icon-btn delete" onclick="delClient(${i})" title="O'chirish"><i data-feather="trash-2" style="width:16px"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            $('st-debt').innerText = fmt(totDebt);
            $('st-paid').innerText = fmt(totPaid);
            $('st-trade').innerText = fmt(totTrade);
            feather.replace();
        }

        // --- OMBORXONA ---
        function renderWarehouse() {
            const tbody = $('tbody-warehouse'); tbody.innerHTML = '';
            DB.warehouse.forEach((w, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${w.img || 'https://via.placeholder.com/40?text=Foto'}" class="product-img"></td>
                    <td style="font-weight:600">${w.name}</td>
                    <td><span style="background:var(--col-pale-green); padding:4px 8px; border-radius:6px; font-size:12px; color:var(--primary)">${w.unit}</span></td>
                    <td style="font-weight:700">${fmt(w.qty)}</td>
                    <td>${fmt(w.price)} so'm</td>
                    <td style="text-align:right"><button class="icon-btn delete" onclick="delProduct(${i})"><i data-feather="trash-2" style="width:16px"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- HARAJATLAR ---
        function renderExpenses() {
            const tbody = $('tbody-expenses'); tbody.innerHTML = '';
            let total = 0;
            DB.expenses.slice().reverse().forEach((e, i) => {
                total += parse(e.amount);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.reason}</td>
                    <td style="color:var(--danger); font-weight:700">-${fmt(e.amount)}</td>
                    <td style="text-align:right"><button class="icon-btn delete" onclick="delExpense(${DB.expenses.length - 1 - i})"><i data-feather="trash-2" style="width:16px"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
            $('st-exp-total').innerText = fmt(total);
        }

        // --- TARIX VA SAVDO ---
        function openHistory(i) {
            currClientIdx = i;
            $('histClientName').innerText = DB.clients[i].name;
            
            const sel = $('t_prod');
            sel.innerHTML = '<option value="">-- Omborxonadan tanlash --</option>';
            DB.warehouse.forEach(w => {
                sel.innerHTML += `<option value="${w.id}" data-price="${w.price}">${w.name} (${w.qty} ${w.unit})</option>`;
            });
            
            renderHistoryTable();
            $('dlgHistory').showModal();
        }

        function autoFillPrice() {
            const sel = $('t_prod');
            const opt = sel.options[sel.selectedIndex];
            if(opt.dataset.price) $('t_price').value = opt.dataset.price;
        }

        function addTrade(e) {
            e.preventDefault();
            const prodId = $('t_prod').value;
            const qty = parse($('t_qty').value);
            let prodName = $('t_prod').options[$('t_prod').selectedIndex].text;
            
            if(prodId) {
                const w = DB.warehouse.find(x => x.id === prodId);
                if(w.qty < qty) { alert("Omborda yetarli emas!"); return; }
                w.qty -= qty;
                prodName = w.name;
            } else {
                prodName = $('t_note').value || 'Tovarlar';
            }

            const rec = {
                type: 'trade', date: new Date().toLocaleDateString(),
                prodId: prodId, name: prodName, qty: qty,
                price: parse($('t_price').value), note: $('t_note').value
            };
            
            DB.clients[currClientIdx].history.push(rec);
            DB.save(); renderHistoryTable(); e.target.reset();
        }

        function addPayment(e) {
            e.preventDefault();
            const rec = {
                type: 'pay', date: new Date().toLocaleDateString(),
                method: $('p_method').value, amount: parse($('p_amount').value)
            };
            DB.clients[currClientIdx].history.push(rec);
            DB.save(); renderHistoryTable(); $('p_amount').value = '';
        }

        function renderHistoryTable() {
            const tbody = $('tbody-history'); tbody.innerHTML = '';
            const hist = DB.clients[currClientIdx].history || [];
            
            hist.slice().reverse().forEach((h, idx) => {
                const realIdx = hist.length - 1 - idx;
                const tr = document.createElement('tr');
                if(h.type === 'trade') {
                    tr.innerHTML = `
                        <td>${h.date}</td>
                        <td><b>${h.name}</b> <br> <span style="font-size:12px; color:gray">${h.qty} x ${fmt(h.price)}</span></td>
                        <td style="font-weight:700; color:var(--text-main)">${fmt(h.qty * h.price)}</td>
                        <td style="text-align:right"><button class="icon-btn delete" onclick="delHist(${realIdx})"><i data-feather="x" style="width:14px"></i></button></td>
                    `;
                } else {
                    let m = h.method === 'click' ? 'Click' : (h.method==='card'?'Karta':'Naqd');
                    tr.innerHTML = `
                        <td>${h.date}</td>
                        <td>To'lov (${m})</td>
                        <td style="color:var(--primary); font-weight:700">+${fmt(h.amount)}</td>
                        <td style="text-align:right"><button class="icon-btn delete" onclick="delHist(${realIdx})"><i data-feather="x" style="width:14px"></i></button></td>
                    `;
                }
                tbody.appendChild(tr);
            });
            feather.replace();
        }

        function delHist(idx) {
            if(!confirm("O'chirilsinmi?")) return;
            const h = DB.clients[currClientIdx].history[idx];
            if(h.type === 'trade' && h.prodId) {
                const w = DB.warehouse.find(x => x.id === h.prodId);
                if(w) w.qty += parse(h.qty);
            }
            DB.clients[currClientIdx].history.splice(idx, 1);
            DB.save(); renderHistoryTable();
        }

        // --- CRUD ACTIONS ---
        function saveClient(e) {
            e.preventDefault();
            DB.clients.push({ name: $('c_name').value, phone: $('c_phone').value, init: $('c_init').value, history: [] });
            DB.save(); closeModal('dlgClient'); e.target.reset();
        }
        function delClient(i) { if(confirm("Aniqmi?")) { DB.clients.splice(i,1); DB.save(); } }

        function saveProduct(e) {
            e.preventDefault();
            const file = $('w_img_file').files[0];
            const reader = new FileReader();
            const done = (img) => {
                DB.warehouse.push({ id: genId(), img: img, name: $('w_name').value, unit: $('w_unit').value, qty: parse($('w_qty').value), price: parse($('w_price').value) });
                DB.save(); closeModal('dlgProduct'); e.target.reset();
            };
            if(file) { reader.readAsDataURL(file); reader.onload = () => done(reader.result); } else done(null);
        }
        function delProduct(i) { if(confirm("Aniqmi?")) { DB.warehouse.splice(i,1); DB.save(); } }

        function saveExpense(e) {
            e.preventDefault();
            DB.expenses.push({ date: $('e_date').value, reason: $('e_reason').value, amount: parse($('e_amount').value) });
            DB.save(); closeModal('dlgExpense'); e.target.reset();
        }
        function delExpense(i) { if(confirm("Aniqmi?")) { DB.expenses.splice(i,1); DB.save(); } }

        // --- MODAL UTILS ---
        function openModal(id) { $(id).showModal(); }
        function closeModal(id) { $(id).close(); }

        // --- CHARTS & EXCEL ---
        function renderCharts() {
            const ctxPie = $('chartPie'); const ctxBar = $('chartBar');
            // Logic for charts (Top Qarzdorlar, Balance)
            const debtors = DB.clients.map(c => {
                let d = parse(c.init||0); c.history?.forEach(h => d += (h.type==='trade'?(h.qty*h.price):-h.amount));
                return {name: c.name, debt: d};
            }).filter(x => x.debt > 0).sort((a,b) => b.debt - a.debt).slice(0,5);

            if(window.myPie) window.myPie.destroy();
            window.myPie = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: debtors.map(d => d.name),
                    datasets: [{ data: debtors.map(d => d.debt), backgroundColor: ['#337B01', '#76B947', '#2F5233', '#BEEAC5', '#99CC66'] }]
                },
                options: { plugins: { title: { display: true, text: 'Top 5 Qarzdorlar' } } }
            });
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const cData = DB.clients.map(c => {
                let d = parse(c.init||0), p = 0, t = 0;
                c.history?.forEach(h => { if(h.type==='trade'){ let v=h.qty*h.price; d+=v; t+=v; } else { d-=h.amount; p+=h.amount; } });
                return { "Ism": c.name, "Telefon": c.phone, "Savdo": t, "To'lov": p, "Qarz": d };
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cData), "Mijozlar");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(DB.warehouse), "Ombor");
            XLSX.writeFile(wb, "Hisobot.xlsx");
        }

        function refreshAll() { renderClients(); renderWarehouse(); renderExpenses(); }
        refreshAll();
        feather.replace();
    </script>
</body>
</html>

