<!-- ======= Xaridlar tarixi (sana bilan) — mavjud saytga ziyon yetkazmasdan qo‘shiladigan modul ======= -->
<style>
  /* Minimal uslub (saytingizga to‘qnash kelmasligi uchun prefikslar bilan) */
  .xh-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:flex;align-items:center;justify-content:center;z-index:99999}
  .xh-backdrop[hidden]{display:none}
  .xh-modal{background:#fff;max-width:960px;width:95%;border-radius:10px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,.2)}
  .xh-modal h3{margin:0 0 8px 0}
  .xh-row{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0}
  .xh-row label{font-size:12px;color:#444;display:block;margin-bottom:4px}
  .xh-row input,.xh-row textarea{padding:8px;border:1px solid #ddd;border-radius:8px;min-width:180px}
  .xh-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
  .xh-btn{border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .xh-btn.primary{background:#1976d2;color:#fff}
  .xh-btn.ghost{background:#f2f2f2}
  .xh-table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  .xh-table th,.xh-table td{border-bottom:1px solid #eee;padding:8px;text-align:left;vertical-align:top}
  .xh-badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#efefef;font-size:12px}
  @media (max-width:600px){ .xh-row input,.xh-row textarea{min-width:unset;width:100%} }
</style>

<!-- Tarixni ko‘rish modali -->
<div id="xh-history" class="xh-backdrop" hidden>
  <div class="xh-modal">
    <h3>Xaridlar tarixi — <span id="xh-name"></span> <span class="xh-badge" id="xh-phone"></span></h3>
    <table class="xh-table">
      <thead>
        <tr>
          <th>Sana</th><th>Tovar</th><th>Dona</th><th>Narx (1 dona)</th><th>Jami</th><th>Izoh</th><th>Amal</th>
        </tr>
      </thead>
      <tbody id="xh-tbody"></tbody>
    </table>
    <div class="xh-actions">
      <button class="xh-btn ghost" id="xh-close">Yopish</button>
      <button class="xh-btn primary" id="xh-add">Xarid qo‘shish</button>
    </div>
  </div>
</div>

<!-- Xarid qo‘shish modali -->
<div id="xp-add" class="xh-backdrop" hidden>
  <div class="xh-modal">
    <h3>Yangi xarid</h3>
    <div class="xh-row">
      <div>
        <label>Mijoz</label>
        <input id="xp-name" type="text" readonly>
      </div>
      <div>
        <label>Telefon</label>
        <input id="xp-phone" type="text" readonly>
      </div>
      <div>
        <label>Sana</label>
        <input id="xp-date" type="date">
      </div>
    </div>
    <div class="xh-row">
      <div>
        <label>Tovar nomi</label>
        <input id="xp-item" type="text" placeholder="Masalan: Shakar 1kg">
      </div>
      <div>
        <label>Dona / miqdor</label>
        <input id="xp-qty" type="number" min="0" step="1" value="1">
      </div>
      <div>
        <label>Narx (1 dona uchun)</label>
        <input id="xp-price" type="number" min="0" step="0.01" value="0">
      </div>
    </div>
    <div class="xh-row" style="width:100%">
      <div style="flex:1">
        <label>Izoh (ixtiyoriy)</label>
        <textarea id="xp-note" rows="2" style="width:100%"></textarea>
      </div>
    </div>
    <div class="xh-actions">
      <button class="xh-btn ghost" id="xp-cancel">Bekor</button>
      <button class="xh-btn primary" id="xp-save">Saqlash</button>
    </div>
  </div>
</div>

<script>
/* ======= Xaridlar tarixi moduli (localStorage: purchaseHistory_v1) — NARSA HECH NARSANI BUZMAYDI ======= */
(function(){
  const STORAGE_KEY = 'purchaseHistory_v1';
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const tzOffsetMs = (new Date()).getTimezoneOffset()*60000;
  const todayLocal = () => new Date(Date.now()-tzOffsetMs).toISOString().slice(0,10);
  const money = n => (Number(n||0)).toLocaleString('uz-UZ');

  let CURRENT_KEY = null; // "phone|name"

  function loadDB(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
    catch(e){ return {}; }
  }
  function saveDB(db){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  }
  function keyOf(phone, name){
    const p = (phone||'').replace(/\D/g,''); // raqamlarni ajratamiz
    return p + '|' + (name||'').trim();
  }
  function getList(db, key){
    if(!db[key]) db[key] = [];
    return db[key];
  }

  // === Modallar
  const historyModal = $('#xh-history');
  const addModal = $('#xp-add');

  function openHistory(name, phone){
    CURRENT_KEY = keyOf(phone, name);
    $('#xh-name').textContent = name||'';
    $('#xh-phone').textContent = phone||'';
    renderHistory();
    historyModal.hidden = false;
  }
  function closeHistory(){ historyModal.hidden = true; }

  function openAdd(){
    const [phone, name] = CURRENT_KEY.split('|').length===2
      ? [CURRENT_KEY.split('|')[0], CURRENT_KEY.split('|')[1]]
      : ['', ''];
    $('#xp-name').value = name || $('#xh-name').textContent || '';
    $('#xp-phone').value = $('#xh-phone').textContent || '';
    $('#xp-date').value = todayLocal();
    $('#xp-item').value = '';
    $('#xp-qty').value = 1;
    $('#xp-price').value = 0;
    $('#xp-note').value = '';
    addModal.hidden = false;
  }
  function closeAdd(){ addModal.hidden = true; }

  function renderHistory(){
    const db = loadDB();
    const list = getList(db, CURRENT_KEY).slice().sort((a,b)=> (a.date>b.date?-1:1));
    const tb = $('#xh-tbody');
    tb.innerHTML = '';
    list.forEach((x, i)=>{
      const tr = document.createElement('tr');
      const total = (Number(x.qty||0) * Number(x.price||0));
      tr.innerHTML = `
        <td>${x.date||''}</td>
        <td>${x.item||''}</td>
        <td>${x.qty||0}</td>
        <td>${money(x.price||0)}</td>
        <td><b>${money(total)}</b></td>
        <td>${x.note?String(x.note).replace(/</g,'&lt;'):''}</td>
        <td><button class="xh-btn ghost" data-del="${i}">O‘chirish</button></td>
      `;
      tb.appendChild(tr);
    });
    // delete handlers
    tb.querySelectorAll('button[data-del]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const idx = Number(btn.getAttribute('data-del'));
        const db2 = loadDB();
        const arr = getList(db2, CURRENT_KEY);
        arr.splice(idx, 1);
        saveDB(db2);
        renderHistory();
      });
    });
  }

  // === Add form
  $('#xp-save').addEventListener('click', ()=>{
    const rec = {
      date: $('#xp-date').value || todayLocal(),
      item: $('#xp-item').value.trim(),
      qty: Number($('#xp-qty').value||0),
      price: Number($('#xp-price').value||0),
      note: $('#xp-note').value.trim()
    };
    if(!rec.item){ alert('Tovar nomini kiriting.'); return; }
    const db = loadDB();
    const list = getList(db, CURRENT_KEY);
    list.push(rec);
    saveDB(db);
    closeAdd();
    renderHistory();
  });
  $('#xp-cancel').addEventListener('click', closeAdd);
  $('#xh-add').addEventListener('click', openAdd);
  $('#xh-close').addEventListener('click', closeHistory);

  // === Jadvaldagi har bir mijoz qatoriga "Tarix" tugmasini ulash
  function attachButtons(){
    // Sahifadagi asosiy jadvalni topamiz
    const table = document.querySelector('table');
    if(!table) return;

    // Sarlavhalar asosida ustun indekslarini aniqlaymiz
    const headerRow = table.tHead ? table.tHead.rows[0] : table.querySelector('tr');
    if(!headerRow) return;
    const headers = Array.from(headerRow.cells).map(th=> (th.textContent||'').trim());
    const idxName = headers.findIndex(t=> /Ism/i.test(t));
    const idxPhone = headers.findIndex(t=> /Telefon/i.test(t));
    const idxAmal = headers.findIndex(t=> /Amal/i.test(t));
    if(idxName===-1 || idxPhone===-1) return;

    const bodyRows = table.tBodies.length ? table.tBodies[0].rows : table.querySelectorAll('tbody tr');
    Array.from(bodyRows).forEach(tr=>{
      if(tr.dataset.xhReady) return; // bir marta ulaymiz
      tr.dataset.xhReady = '1';

      const nameCell = tr.cells[idxName];
      const phoneCell = tr.cells[idxPhone];
      const actionCell = idxAmal!==-1 ? tr.cells[idxAmal] : tr.cells[tr.cells.length-1];

      if(!nameCell || !phoneCell || !actionCell) return;

      const name = (nameCell.innerText||'').trim();
      const phone = (phoneCell.innerText||'').trim();

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'xh-btn ghost';
      btn.style.marginLeft = '6px';
      btn.textContent = 'Tarix';
      btn.addEventListener('click', ()=> openHistory(name, phone));
      actionCell.appendChild(btn);
    });
  }

  // Dinamik o‘zgarishlar uchun kuzatuvchi (mijoz qo‘shilganda ham tugma paydo bo‘ladi)
  const obs = new MutationObserver(()=> setTimeout(attachButtons, 0));
  obs.observe(document.body, {childList:true, subtree:true});
  // Dastlabki ulash
  attachButtons();

  // === Ixtiyoriy: “Qarz qo‘shish” oynasiga (agar bo‘lsa) Jami ni auto hisoblash uchun qulaylik ===
  // Agar saytingizda qarz qo‘shish modalida miqdor/narx inputlari bo‘lsa, Jami = Miqdor × Narx ni hisoblab turish
  // (selectorlar mos kelmasa, bu qism hech narsani qilmaydi — xavfsiz)
  function enhanceDebtIfExists(){
    const qty = document.querySelector('input[name*="qty"], input#qty, input[placeholder*="Miqdor" i]');
    const price = document.querySelector('input[name*="price"], input#price, input[placeholder*="Narx" i]');
    const total = document.querySelector('input[name*="total"], input#total, input[placeholder*="Jami" i]');
    if(!qty || !price || !total) return;
    const recalc = () => { total.value = (Number(qty.value||0)*Number(price.value||0)).toFixed(2); };
    qty.addEventListener('input', recalc);
    price.addEventListener('input', recalc);
  }
  const obs2 = new MutationObserver(()=> setTimeout(enhanceDebtIfExists,0));
  obs2.observe(document.body,{childList:true,subtree:true});
  enhanceDebtIfExists();

})();
</script>
<!-- ======= /Xaridlar tarixi moduli ======= -->