<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qarz Tizimi - Pro</title>
    
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            /* Palette -06 */
            --col-deep: #2F5233;   
            --col-main: #337B01;   
            --col-soft: #76B947;   
            --col-pale: #BEEAC5;   
            
            --primary: var(--col-main);
            --primary-hover: var(--col-deep);
            --bg-body: #ffffff;
            --text-main: #2D2D2D;
            --text-muted: #6b7280;
            --border: var(--col-pale);
            --danger: #ef4444;
            --radius: 8px;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background: var(--bg-body); display: flex; height: 100vh; overflow: hidden; color: var(--text-main); }

        /* Sidebar */
        .sidebar { width: var(--sidebar-width); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 24px; background: #fff; }
        .brand { color: var(--primary); font-size: 22px; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: var(--radius); color: var(--text-muted); cursor: pointer; transition: .2s; font-weight: 500; border: none; background: none; width: 100%; text-align: left; }
        .nav-item:hover { background: var(--col-pale); color: var(--col-deep); }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(51, 123, 1, 0.3); }

        /* Main */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-header { height: 64px; border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 32px; justify-content: space-between; background: #fff; }
        .content-area { padding: 32px; overflow-y: auto; height: 100%; }

        /* UI Elements */
        .btn { padding: 10px 18px; border-radius: var(--radius); border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; transition: .2s; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 5px rgba(51,123,1,0.2); }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-outline:hover { background: var(--col-pale); }

        .form-control { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: var(--radius); outline: none; margin-top: 5px; font-size: 14px; }
        .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(51,123,1,0.1); }
        .input-label { font-size: 12px; font-weight: 600; color: var(--col-deep); margin-bottom: 2px; display: block; }

        /* Table */
        .card { border: 1px solid var(--border); border-radius: 12px; overflow: hidden; margin-bottom: 30px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 16px; background: #f0fdf4; color: var(--col-deep); font-size: 12px; text-transform: uppercase; font-weight: 700; border-bottom: 1px solid var(--border); }
        td { padding: 14px 16px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:hover td { background: #f9fff9; }
        tr.warn-row td { background: rgba(239, 68, 68, 0.05); }

        /* Dialog */
        dialog { position: fixed; inset: 0; margin: auto; z-index: 9999; border: none; border-radius: 12px; width: 90%; max-width: 750px; padding: 0; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        dialog::backdrop { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .modal-body { padding: 24px; max-height: 75vh; overflow-y: auto; background: #fcfcfc; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; background: #fff; }

        .view-section { display: none; }
        .view-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0; transform:translateY(5px)} to{opacity:1; transform:translateY(0)} }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-card { padding: 20px; border: 1px solid var(--border); border-radius: 12px; background: #fff; }
        .stat-val { font-size: 24px; font-weight: 800; margin-top: 5px; }
        
        .icon-btn { padding: 6px; border-radius: 6px; border: none; background: none; cursor: pointer; color: var(--text-muted); transition: .2s; }
        .icon-btn:hover { background: var(--col-pale); color: var(--primary); }
        .icon-btn.delete:hover { background: #fee2e2; color: var(--danger); }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand"><i data-feather="box"></i> Qarz Tizimi</div>
        <nav class="nav-menu">
            <button onclick="switchTab('mijozlar')" class="nav-item active" id="nav-mijozlar"><i data-feather="users"></i> Mijozlar</button>
            <button onclick="switchTab('omborxona')" class="nav-item" id="nav-omborxona"><i data-feather="layers"></i> Omborxona</button>
            <button onclick="switchTab('harajatlar')" class="nav-item" id="nav-harajatlar"><i data-feather="trending-down"></i> Harajatlar</button>
            <button onclick="switchTab('statistika')" class="nav-item" id="nav-statistika"><i data-feather="pie-chart"></i> Hisobot</button>
            <button onclick="exportExcel()" class="nav-item" style="margin-top:auto"><i data-feather="download"></i> Excel Yuklash</button>
        </nav>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <h3 id="page-title" style="color:var(--col-deep)">Mijozlar</h3>
            <span style="font-size:13px; font-weight:500; color:var(--primary)" id="current-date"></span>
        </header>

        <div class="content-area">
            
            <div id="view-mijozlar" class="view-section active">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px">
                    <input id="search-client" class="form-control" style="max-width:300px; margin:0" placeholder="Qidirish..." oninput="renderClients()">
                    <button class="btn btn-primary" onclick="openClientModal()"><i data-feather="plus"></i> Yangi Mijoz</button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div style="font-size:12px; font-weight:600; color:#888">UMUMIY QARZ</div>
                        <div class="stat-val" id="st-debt" style="color:var(--danger)">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size:12px; font-weight:600; color:#888">TO'LANGAN</div>
                        <div class="stat-val" id="st-paid" style="color:var(--primary)">0</div>
                    </div>
                    <div class="stat-card">
                        <div style="font-size:12px; font-weight:600; color:#888">JAMI SAVDO</div>
                        <div class="stat-val" id="st-trade" style="color:var(--text-main)">0</div>
                    </div>
                </div>

                <div class="card">
                    <table>
                        <thead><tr><th>Mijoz</th><th>Telefon</th><th>Savdo</th><th>To'lov</th><th>Qarz</th><th style="text-align:right">Amallar</th></tr></thead>
                        <tbody id="tbody-clients"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-omborxona" class="view-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                    <h2 style="color:var(--primary)">Omborxona</h2>
                    <button class="btn btn-primary" onclick="openProductModal()"><i data-feather="plus"></i> Mahsulot Qo'shish</button>
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>Nomi</th><th>Birlik</th><th>Qoldiq</th><th>Narx</th><th style="text-align:right">Amallar</th></tr></thead>
                        <tbody id="tbody-warehouse"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-harajatlar" class="view-section">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px">
                    <h2 style="color:var(--primary)">Harajatlar</h2>
                    <button class="btn btn-primary" onclick="openExpenseModal()"><i data-feather="minus-circle"></i> Harajat</button>
                </div>
                <div class="card">
                    <table>
                        <thead><tr><th>Sana</th><th>Sabab</th><th>Summa</th><th style="text-align:right">Amal</th></tr></thead>
                        <tbody id="tbody-expenses"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-statistika" class="view-section">
                <h2 style="color:var(--primary); margin-bottom:20px">Statistika</h2>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="stat-card"><canvas id="chartPie"></canvas></div>
                    <div class="stat-card"><canvas id="chartBar"></canvas></div>
                </div>
            </div>

        </div>
    </main>

    <dialog id="dlgClient">
        <div class="modal-header">
            <span style="font-weight:700; font-size:18px" id="dlgClientTitle">Mijoz</span>
            <button onclick="closeModal('dlgClient')" style="border:none; bg:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <form onsubmit="saveClient(event)">
            <div class="modal-body">
                <div style="display:grid; gap:15px">
                    <div>
                        <label class="input-label">Ism Familiya</label>
                        <input id="c_name" class="form-control" required>
                    </div>
                    <div>
                        <label class="input-label">Telefon</label>
                        <input id="c_phone" class="form-control">
                    </div>
                    <div>
                        <label class="input-label">Eski Qarz (Agar bo'lsa)</label>
                        <input id="c_init" type="number" class="form-control" value="0">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeModal('dlgClient')">Yopish</button>
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgHistory">
        <div class="modal-header">
            <span style="font-weight:700; font-size:18px"><span id="histClientName"></span> â€” Tarix va Savdo</span>
            <button onclick="closeModal('dlgHistory')" style="border:none; bg:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <div class="modal-body">
            
            <div style="background:white; padding:20px; border:1px solid var(--border); border-radius:12px; margin-bottom:20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
                <h4 style="color:var(--col-deep); margin-bottom:15px; display:flex; gap:8px; align-items:center"><i data-feather="shopping-cart" style="width:18px"></i> Yangi Savdo Qo'shish</h4>
                <form onsubmit="addTrade(event)">
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px">
                        <div style="grid-column: span 2">
                            <label class="input-label">Ombordan tanlash (Ixtiyoriy)</label>
                            <select id="t_prod" class="form-control" onchange="onProductSelect()">
                                <option value="">-- Tanlanmagan --</option>
                            </select>
                        </div>
                        
                        <div style="border:1px dashed var(--col-soft); padding:10px; border-radius:8px;">
                            <label class="input-label">Dona Soni</label>
                            <input id="t_qty_dona" type="number" step="any" class="form-control" placeholder="0">
                            <label class="input-label" style="margin-top:5px">Narx (1 dona)</label>
                            <input id="t_price_dona" type="number" class="form-control" placeholder="0">
                        </div>

                        <div style="border:1px dashed var(--col-soft); padding:10px; border-radius:8px;">
                            <label class="input-label">Uzunlik (Sm)</label>
                            <input id="t_len_sm" type="number" step="any" class="form-control" placeholder="0">
                            <label class="input-label" style="margin-top:5px">Narx (1 sm)</label>
                            <input id="t_price_sm" type="number" class="form-control" placeholder="0">
                        </div>

                        <div style="grid-column: span 2">
                            <label class="input-label">Izoh</label>
                            <input id="t_note" class="form-control" placeholder="Masalan: Kabel...">
                        </div>
                        <div style="grid-column: span 2">
                            <button class="btn btn-primary" style="width:100%">Savdoni Qo'shish</button>
                        </div>
                    </div>
                </form>
            </div>

            <div style="background:white; padding:20px; border:1px solid var(--border); border-radius:12px; margin-bottom:20px">
                <h4 style="color:var(--col-deep); margin-bottom:15px; display:flex; gap:8px; align-items:center"><i data-feather="credit-card" style="width:18px"></i> To'lov Qabul Qilish</h4>
                <form onsubmit="addPayment(event)" style="display:grid; grid-template-columns: 1fr 1fr auto; gap:10px; align-items:end">
                    <div>
                        <label class="input-label">To'lov Turi</label>
                        <select id="p_method" class="form-control">
                            <option value="cash">Naqd</option>
                            <option value="card">Plastik</option>
                            <option value="click">Click</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Summa</label>
                        <input id="p_amount" type="number" class="form-control" required>
                    </div>
                    <button class="btn btn-primary">Saqlash</button>
                </form>
            </div>

            <div class="card" style="margin-bottom:0">
                <table style="font-size:13px">
                    <thead><tr><th>Sana</th><th>Ma'lumot</th><th>Hisob</th><th>Summa</th><th style="text-align:right">Amal</th></tr></thead>
                    <tbody id="tbody-history"></tbody>
                </table>
            </div>
        </div>
    </dialog>

    <dialog id="dlgProduct">
        <div class="modal-header">
            <span style="font-weight:700; font-size:18px" id="dlgProdTitle">Mahsulot</span>
            <button onclick="closeModal('dlgProduct')" style="border:none; bg:none; cursor:pointer"><i data-feather="x"></i></button>
        </div>
        <form onsubmit="saveProduct(event)">
            <div class="modal-body">
                <div style="display:grid; gap:15px">
                    <div>
                        <label class="input-label">Nomi</label>
                        <input id="w_name" class="form-control" required>
                    </div>
                    <div>
                        <label class="input-label">Birlik</label>
                        <select id="w_unit" class="form-control">
                            <option value="dona">Dona</option>
                            <option value="sm">Sm / Metr</option>
                            <option value="kg">Kg</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Qoldiq</label>
                        <input id="w_qty" type="number" step="any" class="form-control" required>
                    </div>
                    <div>
                        <label class="input-label">Sotish Narxi</label>
                        <input id="w_price" type="number" class="form-control">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-primary">Saqlash</button>
            </div>
        </form>
    </dialog>

    <dialog id="dlgExpense">
        <div class="modal-header"><span style="font-weight:700; font-size:18px">Harajat</span><button onclick="closeModal('dlgExpense')" style="border:none; bg:none; cursor:pointer"><i data-feather="x"></i></button></div>
        <form onsubmit="saveExpense(event)">
            <div class="modal-body">
                <div style="display:grid; gap:15px">
                    <div><label class="input-label">Sana</label><input id="e_date" type="date" class="form-control" required></div>
                    <div><label class="input-label">Summa</label><input id="e_amount" type="number" class="form-control" required></div>
                    <div><label class="input-label">Sabab</label><input id="e_reason" class="form-control" required></div>
                </div>
            </div>
            <div class="modal-footer"><button type="submit" class="btn btn-primary">Saqlash</button></div>
        </form>
    </dialog>

    <script>
        // === UTILS ===
        const $ = id => document.getElementById(id);
        // Raqamlarni 10 000 formatda chiqarish
        const fmt = n => Number(n).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, " "); 
        const parse = n => parseFloat(n) || 0;
        const genId = () => Math.random().toString(36).substr(2,9);
        $('current-date').innerText = new Date().toLocaleDateString('uz-UZ');

        // === DATA ===
        const DB = {
            clients: JSON.parse(localStorage.getItem('gp_clients') || '[]'),
            warehouse: JSON.parse(localStorage.getItem('gp_warehouse') || '[]'),
            expenses: JSON.parse(localStorage.getItem('gp_expenses') || '[]'),
            save: () => {
                localStorage.setItem('gp_clients', JSON.stringify(DB.clients));
                localStorage.setItem('gp_warehouse', JSON.stringify(DB.warehouse));
                localStorage.setItem('gp_expenses', JSON.stringify(DB.expenses));
                refreshAll();
            }
        };

        let currClientIdx = null;
        let currProdIdx = null;

        function switchTab(tab) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            $(`view-${tab}`).classList.add('active');
            $(`nav-${tab}`).classList.add('active');
            if(tab==='statistika') renderCharts();
        }

        // === MIJOZLAR ===
        function renderClients() {
            const tbody = $('tbody-clients'); tbody.innerHTML = '';
            const search = $('search-client').value.toLowerCase();
            let totDebt=0, totPaid=0, totTrade=0;

            DB.clients.forEach((c, i) => {
                let debt = parse(c.init || 0);
                let paid = 0, trade = 0;

                (c.history || []).forEach(h => {
                    if(h.type === 'trade') {
                        // Hisoblash: Dona summasi + Sm summasi
                        let cost = (parse(h.qty_dona)*parse(h.price_dona)) + (parse(h.len_sm)*parse(h.price_sm));
                        debt += cost; trade += cost;
                    } else {
                        debt -= parse(h.amount); paid += parse(h.amount);
                    }
                });

                if(c.name.toLowerCase().includes(search)) {
                    totDebt+=debt; totPaid+=paid; totTrade+=trade;
                    const tr = document.createElement('tr');
                    if(debt > 0) tr.classList.add('warn-row');
                    tr.innerHTML = `
                        <td><div style="font-weight:700; color:var(--primary)">${c.name}</div></td>
                        <td>${c.phone||'-'}</td>
                        <td>${fmt(trade)}</td>
                        <td style="color:var(--col-soft)">${fmt(paid)}</td>
                        <td style="color:var(--danger); font-weight:800">${fmt(debt)}</td>
                        <td style="text-align:right">
                            <button class="btn btn-primary" style="padding:6px 12px; font-size:12px" onclick="openHistory(${i})">Tarix va Savdo</button>
                            <button class="icon-btn" onclick="editClient(${i})"><i data-feather="edit-2"></i></button>
                            <button class="icon-btn delete" onclick="delClient(${i})"><i data-feather="trash-2"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            $('st-debt').innerText = fmt(totDebt);
            $('st-paid').innerText = fmt(totPaid);
            $('st-trade').innerText = fmt(totTrade);
            feather.replace();
        }

        function openClientModal() { currClientIdx=null; $('dlgClientTitle').innerText="Yangi Mijoz"; $('c_name').value=''; $('c_phone').value=''; $('c_init').value=0; $('dlgClient').showModal(); }
        function editClient(i) {
            currClientIdx = i; const c = DB.clients[i];
            $('dlgClientTitle').innerText="Mijozni Tahrirlash"; $('c_name').value=c.name; $('c_phone').value=c.phone; $('c_init').value=c.init||0;
            $('dlgClient').showModal();
        }
        function saveClient(e) {
            e.preventDefault();
            const data = { name:$('c_name').value, phone:$('c_phone').value, init:$('c_init').value, history: currClientIdx!==null ? DB.clients[currClientIdx].history : [] };
            if(currClientIdx!==null) DB.clients[currClientIdx]=data; else DB.clients.push(data);
            DB.save(); closeModal('dlgClient');
        }
        function delClient(i) { if(confirm("O'chirilsinmi?")) { DB.clients.splice(i,1); DB.save(); } }

        // === TARIX VA SAVDO (TUGRILANGAN QISM) ===
        function openHistory(i) {
            currClientIdx = i;
            $('histClientName').innerText = DB.clients[i].name;
            const sel = $('t_prod'); sel.innerHTML = '<option value="">-- Tanlanmagan --</option>';
            DB.warehouse.forEach(w => sel.innerHTML += `<option value="${w.id}">${w.name} (${w.qty} ${w.unit})</option>`);
            
            // Inputlarni tozalash
            $('t_qty_dona').value=''; $('t_price_dona').value='';
            $('t_len_sm').value=''; $('t_price_sm').value=''; $('t_note').value='';
            
            // Inputlarni ochish (blokdan chiqarish)
            $('t_qty_dona').disabled = false; $('t_len_sm').disabled = false;

            renderHistoryTable(); $('dlgHistory').showModal();
        }

        function onProductSelect() {
            const id = $('t_prod').value;
            const w = DB.warehouse.find(x => x.id === id);
            
            if(w) {
                if(w.unit === 'dona') {
                    $('t_qty_dona').disabled = false; $('t_qty_dona').focus();
                    $('t_price_dona').value = w.price;
                    $('t_len_sm').disabled = true; $('t_len_sm').value=''; $('t_price_sm').value='';
                } else {
                    $('t_len_sm').disabled = false; $('t_len_sm').focus();
                    $('t_price_sm').value = w.price;
                    $('t_qty_dona').disabled = true; $('t_qty_dona').value=''; $('t_price_dona').value='';
                }
            } else {
                $('t_qty_dona').disabled=false; $('t_len_sm').disabled=false;
            }
        }

        function addTrade(e) {
            e.preventDefault();
            const prodId = $('t_prod').value;
            // MUHIM: Har ikkala inputni o'qiymiz
            const qDona = parse($('t_qty_dona').value);
            const pDona = parse($('t_price_dona').value);
            const qSm = parse($('t_len_sm').value);
            const pSm = parse($('t_price_sm').value);
            
            let pName = $('t_note').value || 'Tovar';
            if(prodId) {
                const w = DB.warehouse.find(x => x.id === prodId);
                const req = w.unit==='dona' ? qDona : qSm;
                if(w.qty < req) { alert("Omborda yetarli emas!"); return; }
                w.qty -= req;
                pName = w.name;
            }

            // Agar ikkalasi ham bo'sh bo'lsa
            if(qDona <= 0 && qSm <= 0) {
                alert("Iltimos, miqdor kiriting (Dona yoki Sm)");
                return;
            }

            const rec = {
                type: 'trade',
                date: new Date().toLocaleDateString('uz-UZ'),
                prodId: prodId,
                name: pName,
                qty_dona: qDona, price_dona: pDona,
                len_sm: qSm, price_sm: pSm,
                note: $('t_note').value
            };
            
            DB.clients[currClientIdx].history.push(rec);
            DB.save(); 
            
            // Formani tozalash
            $('t_qty_dona').value=''; $('t_len_sm').value=''; $('t_note').value='';
            renderHistoryTable(); 
        }

        function addPayment(e) {
            e.preventDefault();
            const rec = {
                type: 'pay', date: new Date().toLocaleDateString('uz-UZ'),
                method: $('p_method').value, amount: parse($('p_amount').value)
            };
            DB.clients[currClientIdx].history.push(rec);
            DB.save(); renderHistoryTable(); $('p_amount').value='';
        }

        function renderHistoryTable() {
            const tbody = $('tbody-history'); tbody.innerHTML = '';
            const hist = DB.clients[currClientIdx].history || [];
            
            hist.slice().reverse().forEach((h, idx) => {
                const realIdx = hist.length - 1 - idx;
                const tr = document.createElement('tr');
                
                if(h.type === 'trade') {
                    let details = `<b>${h.name}</b>`;
                    let math = '';
                    let total = 0;

                    if(h.qty_dona > 0) {
                        math += `<div>${h.qty_dona} dona x ${fmt(h.price_dona)}</div>`;
                        total += h.qty_dona * h.price_dona;
                    }
                    if(h.len_sm > 0) {
                        math += `<div>${h.len_sm} sm x ${fmt(h.price_sm)}</div>`;
                        total += h.len_sm * h.price_sm;
                    }

                    tr.innerHTML = `
                        <td>${h.date}</td>
                        <td>${details}<br><small style="color:#888">${h.note||''}</small></td>
                        <td style="font-size:12px; color:#555">${math}</td>
                        <td style="font-weight:700">${fmt(total)}</td>
                        <td style="text-align:right"><button class="icon-btn delete" onclick="delHist(${realIdx})"><i data-feather="x"></i></button></td>
                    `;
                } else {
                    let badge = h.method==='click' ? 'Click' : (h.method==='card'?'Plastik':'Naqd');
                    tr.innerHTML = `
                        <td>${h.date}</td>
                        <td>To'lov (${badge})</td>
                        <td>-</td>
                        <td style="color:var(--primary); font-weight:700">+${fmt(h.amount)}</td>
                        <td style="text-align:right"><button class="icon-btn delete" onclick="delHist(${realIdx})"><i data-feather="x"></i></button></td>
                    `;
                }
                tbody.appendChild(tr);
            });
            feather.replace();
        }

        function delHist(idx) {
            if(!confirm("O'chirilsinmi?")) return;
            const h = DB.clients[currClientIdx].history[idx];
            if(h.type==='trade' && h.prodId) {
                const w = DB.warehouse.find(x => x.id === h.prodId);
                if(w) w.qty += (w.unit==='dona' ? h.qty_dona : h.len_sm);
            }
            DB.clients[currClientIdx].history.splice(idx,1);
            DB.save(); renderHistoryTable();
        }

        // === OMBORXONA & HARAJAT ===
        function renderWarehouse() {
            const tbody = $('tbody-warehouse'); tbody.innerHTML = '';
            DB.warehouse.forEach((w, i) => {
                tbody.innerHTML += `<tr>
                    <td>${w.name}</td>
                    <td><span style="background:var(--col-pale); padding:2px 6px; border-radius:4px; font-size:12px; color:var(--col-deep)">${w.unit}</span></td>
                    <td style="font-weight:700">${fmt(w.qty)}</td>
                    <td>${fmt(w.price)}</td>
                    <td style="text-align:right">
                        <button class="icon-btn" onclick="editProduct(${i})"><i data-feather="edit"></i></button>
                        <button class="icon-btn delete" onclick="delProduct(${i})"><i data-feather="trash-2"></i></button>
                    </td></tr>`;
            });
        }
        function openProductModal() { currProdIdx=null; $('dlgProdTitle').innerText="Yangi Mahsulot"; $('w_name').value=''; $('w_qty').value=''; $('w_price').value=''; $('dlgProduct').showModal(); }
        function editProduct(i) { currProdIdx = i; const w = DB.warehouse[i]; $('dlgProdTitle').innerText = "Mahsulotni Tahrirlash"; $('w_name').value = w.name; $('w_unit').value = w.unit; $('w_qty').value = w.qty; $('w_price').value = w.price; $('dlgProduct').showModal(); }
        function saveProduct(e) { e.preventDefault(); const data = { id: currProdIdx!==null?DB.warehouse[currProdIdx].id:genId(), name:$('w_name').value, unit:$('w_unit').value, qty:parse($('w_qty').value), price:parse($('w_price').value) }; if(currProdIdx!==null) DB.warehouse[currProdIdx]=data; else DB.warehouse.push(data); DB.save(); closeModal('dlgProduct'); }
        function delProduct(i) { if(confirm("O'chirilsinmi?")) { DB.warehouse.splice(i,1); DB.save(); } }

        function renderExpenses() {
            const tbody=$('tbody-expenses'); tbody.innerHTML='';
            DB.expenses.slice().reverse().forEach((e,i)=>{ tbody.innerHTML+=`<tr><td>${e.date}</td><td>${e.reason}</td><td style="color:var(--danger);font-weight:700">-${fmt(e.amount)}</td><td style="text-align:right"><button class="icon-btn delete" onclick="delExp(${DB.expenses.length-1-i})"><i data-feather="trash-2"></i></button></td></tr>`; });
        }
        function openExpenseModal() { $('e_date').valueAsDate=new Date(); $('e_amount').value=''; $('e_reason').value=''; $('dlgExpense').showModal(); }
        function saveExpense(e) { e.preventDefault(); DB.expenses.push({ date:$('e_date').value, reason:$('e_reason').value, amount:parse($('e_amount').value) }); DB.save(); closeModal('dlgExpense'); }
        function delExp(i) { if(confirm("Aniqmi?")) { DB.expenses.splice(i,1); DB.save(); } }

        // === UTILS ===
        function closeModal(id) { $(id).close(); }
        function refreshAll() { renderClients(); renderWarehouse(); renderExpenses(); }
        function exportExcel() {
            const wb = XLSX.utils.book_new();
            const cData = DB.clients.map(c => { let d=parse(c.init||0); (c.history||[]).forEach(h=>d+=(h.type==='trade'?((h.qty_dona*h.price_dona)+(h.len_sm*h.price_sm)):-h.amount)); return { "Mijoz":c.name, "Tel":c.phone, "Qarz":d }; });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(cData), "Mijozlar");
            XLSX.writeFile(wb, "Hisobot.xlsx");
        }
        function renderCharts() {
            const ctxP=$('chartPie'), ctxB=$('chartBar');
            const debtors = DB.clients.map(c=>{ let d=parse(c.init||0); (c.history||[]).forEach(h=>d+=(h.type==='trade'?((h.qty_dona*h.price_dona)+(h.len_sm*h.price_sm)):-h.amount)); return {name:c.name, debt:d}; }).filter(x=>x.debt>0).sort((a,b)=>b.debt-a.debt).slice(0,5);
            if(window.myPie) window.myPie.destroy();
            window.myPie = new Chart(ctxP, { type:'doughnut', data: { labels:debtors.map(d=>d.name), datasets:[{data:debtors.map(d=>d.debt), backgroundColor:['#337B01','#76B947','#2F5233','#BEEAC5','#88CC88']}] } });
        }

        refreshAll();
        feather.replace();
    </script>
</body>
</html>
