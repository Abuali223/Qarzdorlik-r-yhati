<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aliaizer — Nasiya & To'lovlar</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0e1116"/>
  <style>
    :root{
      --bg:#0e1116; --panel:#151a22; --muted:#8a94a6; --text:#e6eefc;
      --accent:#4f8cff; --accent-2:#22c55e; --warn:#ef4444;
      --border:#232936; --chip:#1d2430; --focus:0 0 0 3px rgba(79,140,255,.35); --radius:12px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .container{max-width:1200px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:16px}
    .brand{font-weight:700}.brand small{color:var(--muted);font-weight:500}
    .toolbar{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    button,.btn{border:1px solid var(--border);background:var(--chip);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer;transition:.2s;display:inline-flex;gap:8px;align-items:center}
    button:hover{filter:brightness(1.08)}
    .btn-accent{background:#0f1a2b;border-color:#1e2a3d;box-shadow:var(--focus)}
    .btn-green{background:#0f2316;border-color:#1d3b26;color:#c8f7d1}
    .btn-red{background:#2a1010;border-color:#3b1d1d;color:#ffd0d0}
    .btn-pill{border-radius:999px}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin:12px 0 20px}
    .stat{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px}
    .stat h3{margin:0 0 6px;font-size:12px;color:var(--muted);font-weight:600}
    .stat .num{font-size:22px;font-weight:700}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
    .card-head{display:flex;align-items:center;gap:10px;padding:12px;border-bottom:1px solid var(--border)}
    .card-head h2{margin:0;font-size:16px}
    .search{flex:1;display:flex;gap:8px}
    .field{display:flex;align-items:center;border:1px solid var(--border);background:var(--chip);padding:8px 10px;border-radius:10px;width:100%}
    .field input{background:transparent;border:0;outline:0;color:var(--text);width:100%}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px;border-bottom:1px solid var(--border);text-align:left}
    th{color:var(--muted);font-weight:600;background:rgba(255,255,255,.01)}
    .row-actions{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;color:var(--muted)}
    .empty{color:var(--muted);text-align:center;padding:32px}
    dialog{border:1px solid var(--border);border-radius:14px;background:var(--panel);color:var(--text);padding:0;max-width:640px;width:calc(100% - 24px)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    .modal-head{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700}
    .modal-body{padding:16px;display:grid;gap:12px}
    .modal-foot{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    input[type="number"]{appearance:textfield}
    @media(max-width:900px){.stats{grid-template-columns:1fr}.grid-2,.grid-3{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">Aliaizer — <small>Nasiya & To'lovlar</small></div>
      <div class="toolbar">
        <button id="btnExport">Eksport</button>
        <label class="btn"><input id="fileImport" type="file" accept="application/json" hidden>Import</label>
        <button id="btnSeed" class="btn-green">O'rnatish</button>
        <button id="btnAdmin" class="btn-accent">Admin kirish</button>
      </div>
    </header>

    <section class="stats">
      <div class="stat"><h3>Jami qarz</h3><div class="num" id="statJamiQarz">0</div></div>
      <div class="stat"><h3>Qaytgan to'lov</h3><div class="num" id="statQaytganTolov">0</div></div>
      <div class="stat"><h3>Qoldiq</h3><div class="num" id="statQoldiq">0</div></div>
    </section>

    <div class="card">
      <div class="card-head">
        <h2 style="margin-right:auto">Mijozlar</h2>
        <div class="search">
          <div class="field"><input id="searchInput" placeholder="Qidirish: ism, telefon..."></div>
          <button id="btnAdd" class="btn-green">+ Mijoz qo'shish</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>#</th><th>Ism</th><th>Telefon</th>
              <th>Tovar (dona)</th><th>Narx</th><th>Berilgan</th><th>Qoldiq</th>
              <th>Amal</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div id="empty" class="empty" style="display:none">Hozircha ma'lumot yo'q</div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Customer -->
  <dialog id="dlgCustomer">
    <div class="modal-head" id="dlgCustomerTitle">Mijoz</div>
    <form method="dialog" id="frmCustomer">
      <div class="modal-body">
        <div class="grid-2">
          <label class="field"><input id="cName" required placeholder="Ism" /></label>
          <label class="field"><input id="cPhone" placeholder="Telefon: +998..." /></label>
        </div>
        <div class="grid-3">
          <label class="field"><input id="cQty" type="number" min="0" step="1" placeholder="Tovar dona" /></label>
          <label class="field"><input id="cPrice" type="number" min="0" step="100" placeholder="Narx" /></label>
          <label class="field"><input id="cGiven" type="number" min="0" step="100" placeholder="Berilgan summa" /></label>
        </div>
        <div class="grid-2">
          <div class="field"><input id="cComputed" disabled placeholder="Hisob: Asosiy, Qoldiq"></div>
          <div class="field"><input id="cNote" placeholder="Izoh (ixtiyoriy)"/></div>
        </div>
      </div>
      <div class="modal-foot">
        <button type="button" class="btn" id="btnCancelCustomer">Bekor</button>
        <button type="submit" class="btn-green">Saqlash</button>
      </div>
    </form>
  </dialog>

  <!-- Quick transaction (tovar/qarz/to'lov) with info + confirm -->
  <dialog id="dlgTxn">
    <div class="modal-head" id="dlgTxnTitle">Yangi yozuv</div>
    <form method="dialog" id="frmTxn">
      <div class="modal-body">
        <div class="grid-2">
          <label class="field"><input id="tAmount" type="number" required min="0" step="100" placeholder="Miqdor" /></label>
          <label class="field"><input id="tNote" placeholder="Izoh (ixtiyoriy)" /></label>
        </div>

        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
          <button id="tBase"  type="button" class="btn btn-accent btn-pill" data-type="base">TOVAR (dona+)</button>
          <button id="tQarz"  type="button" class="btn btn-red btn-pill"    data-type="qarz">QARZ</button>
          <button id="tTolov" type="button" class="btn btn-green btn-pill"  data-type="tolov">TO'LOV</button>
        </div>

        <label class="field">
          <input id="tInfo" disabled placeholder="Berilgan (joriy) va Qoldiq (joriy) bu yerda ko'rinadi">
        </label>
      </div>

      <div class="modal-foot">
        <button type="button" class="btn" id="btnCancelTxn">Bekor</button>
        <button type="button" class="btn-green" id="btnCommitTxn">Tasdiqlash</button>
      </div>
    </form>
  </dialog>

  <!-- Report / Detail -->
  <dialog id="dlgReport">
    <div class="modal-head">Hisobot / Mijoz tafsiloti</div>
    <form method="dialog" id="frmReport">
      <div class="modal-body">
        <div class="grid-3">
          <label class="field"><input id="rQty" type="number" min="0" step="1" placeholder="Tovar dona" /></label>
          <label class="field"><input id="rPrice" type="number" min="0" step="100" placeholder="Narx" /></label>
          <label class="field"><input id="rGiven" type="number" min="0" step="100" placeholder="Berilgan" /></label>
        </div>
        <div class="grid-2">
          <div class="field"><input id="rSummary" disabled placeholder="Asosiy, Jami qarz/to'lov, Qoldiq"></div>
          <div class="field"><input id="rPhone" placeholder="Telefon" /></div>
        </div>
      </div>
      <div class="modal-foot">
        <button type="button" class="btn" id="btnCancelReport">Bekor</button>
        <button type="submit" class="btn-green">Tasdiqlash</button>
      </div>
    </form>
  </dialog>

  <script>
  // ===== Data layer & helpers =====
  const storeKey = "nasiya_customers_v6";
  const $ = s => document.querySelector(s);
  const fmt = n => (Number(n)||0).toLocaleString('uz-UZ');

  let customers = load();
  function load(){ try { return JSON.parse(localStorage.getItem(storeKey)) || []; } catch { return []; } }
  function save(){ localStorage.setItem(storeKey, JSON.stringify(customers)); }

  // Asosiy formula:
  // base = qty*price
  // qoldiq = base + qarz - (given + tolov)
  function calc(c){
    const qty   = Math.max(0, Math.floor(Number(c.qty||0)));
    const price = Math.max(0, Number(c.price||0));
    const given = Math.max(0, Number(c.given||0));
    const base  = qty*price;
    const qarz  = (c.txns||[]).filter(x=>x.type==='qarz').reduce((a,b)=>a+Number(b.amount||0),0);
    const tolov = (c.txns||[]).filter(x=>x.type==='tolov').reduce((a,b)=>a+Number(b.amount||0),0);
    const qoldiq = Math.max(0, base + qarz - (given + tolov));
    return {qty, price, given, base, qarz, tolov, qoldiq};
  }

  // ===== UI =====
  function refresh(){
    const q = $('#searchInput').value.trim().toLowerCase();
    const tbody = $('#tbody'); tbody.innerHTML = '';
    let list = customers.map(c=>({...c, ...calc(c)}));
    if(q) list = list.filter(c => (c.name||'').toLowerCase().includes(q) || (c.phone||'').toLowerCase().includes(q));
    $('#empty').style.display = list.length ? 'none' : 'block';

    list.forEach((c,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${c.name||''}</td>
        <td><span class="chip">${c.phone||''}</span></td>
        <td>${fmt(c.qty)}</td>
        <td>${fmt(c.price)}</td>
        <td>${fmt(c.given)}</td>
        <td><strong>${fmt(c.qoldiq)}</strong></td>
        <td class="row-actions">
          <button class="btn-accent btn-pill" data-act="base" data-id="${c.id}">Tovar</button>
          <button class="btn-red btn-pill" data-act="qarz" data-id="${c.id}">Qarz</button>
          <button class="btn-green btn-pill" data-act="tolov" data-id="${c.id}">To'lov</button>
          <button class="btn" data-act="report" data-id="${c.id}">Hisobot</button>
          <button class="btn" data-act="edit" data-id="${c.id}">Tahrirlash</button>
          <button class="btn" data-act="del" data-id="${c.id}">O'chirish</button>
        </td>`;
      tbody.appendChild(tr);
    });

    // Umumiy statistikalar
    const agg = list.reduce((a,c)=>{ a.base+=c.base; a.qarz+=c.qarz; a.tolov+=c.tolov; a.given+=c.given; return a; }, {base:0, qarz:0, tolov:0, given:0});
    const majburiyat = agg.base + agg.qarz;
    const qaytgan = agg.given + agg.tolov;
    const qol = Math.max(0, majburiyat - qaytgan);
    $('#statJamiQarz').textContent = fmt(majburiyat);
    $('#statQaytganTolov').textContent = fmt(qaytgan);
    $('#statQoldiq').textContent = fmt(qol);
  }

  document.getElementById('searchInput').addEventListener('input', refresh);

  // Export / Import / Seed
  document.getElementById('btnExport').onclick = ()=>{
    const blob = new Blob([JSON.stringify(customers,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download='nasiya-data-v6.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  document.getElementById('fileImport').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{ try{ const d=JSON.parse(r.result); if(Array.isArray(d)){ customers=d; save(); refresh(); alert('Import qilindi ✅');} else alert('Noto‘g‘ri fayl'); } catch{ alert('Xatolik'); } }; r.readAsText(f);
  });
  document.getElementById('btnSeed').onclick = ()=>{
    if(!confirm("Namuna ma'lumotlarini o'rnataymi?")) return;
    customers = [
      {id:crypto.randomUUID(),name:'Sanjar',phone:'975151777',qty:10,price:350,given:2000,txns:[]},
      {id:crypto.randomUUID(),name:'Zarina',phone:'931112233',qty:5,price:30000,given:0,txns:[{type:'tolov',amount:20000}]}
    ];
    save(); refresh();
  };
  document.getElementById('btnAdmin').onclick = ()=> alert('Demo rejim: parol talab qilinmaydi.');

  // Table actions
  document.getElementById('tbody').addEventListener('click', e=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const act = btn.dataset.act;
    const c = customers.find(x=>x.id===id); if(!c) return;
    if(act==='del'){ if(confirm("O'chirishni tasdiqlang")){ customers = customers.filter(x=>x.id!==id); save(); refresh(); } return; }
    if(act==='edit') openCustomer(c);
    if(act==='report') openReport(c);
    if(['base','qarz','tolov'].includes(act)) openTxn(c, act);
  });

  // Add customer
  document.getElementById('btnAdd').onclick = ()=> openCustomer();

  // ------- Customer modal
  const dlgCustomer = document.getElementById('dlgCustomer');
  document.getElementById('btnCancelCustomer').onclick = ()=> dlgCustomer.close();

  function updateComputed(){
    const qty = Math.floor(Number(document.getElementById('cQty').value||0));
    const price = Number(document.getElementById('cPrice').value||0);
    const given = Number(document.getElementById('cGiven').value||0);
    const base = Math.max(0, qty)*Math.max(0, price);
    const rest = Math.max(0, base - given);
    document.getElementById('cComputed').value = `Asosiy: ${fmt(base)} | Qoldiq: ${fmt(rest)}`;
  }
  ['cQty','cPrice','cGiven'].forEach(id=> document.addEventListener('input', e=>{ if(e.target.id===id) updateComputed(); }));

  function openCustomer(c){
    document.getElementById('dlgCustomerTitle').textContent = c ? "Mijozni tahrirlash" : "Yangi mijoz";
    document.getElementById('cName').value = c?.name || '';
    document.getElementById('cPhone').value = c?.phone || '';
    document.getElementById('cQty').value = c?.qty || '';
    document.getElementById('cPrice').value = c?.price || '';
    document.getElementById('cGiven').value = c?.given || '';
    document.getElementById('cNote').value = c?.note || '';
    updateComputed();
    dlgCustomer.showModal();

    document.getElementById('frmCustomer').onsubmit = (ev)=>{
      ev.preventDefault();
      const name  = document.getElementById('cName').value.trim();
      if(!name){ alert('Ism shart'); return; }
      const phone = document.getElementById('cPhone').value.trim();
      const qty   = Math.floor(Number(document.getElementById('cQty').value||0));
      const price = Number(document.getElementById('cPrice').value||0);
      const given = Number(document.getElementById('cGiven').value||0);
      const note  = document.getElementById('cNote').value.trim();

      if(c){ c.name=name; c.phone=phone; c.qty=qty; c.price=price; c.given=given; c.note=note; }
      else { customers.push({id:crypto.randomUUID(), name, phone, qty, price, given, note, txns:[]}); }
      save(); refresh(); dlgCustomer.close();
    };
  }

  // ------- Quick Txn modal (tovar/qarz/to'lov) — info + confirm
  const dlgTxn = document.getElementById('dlgTxn');
  document.getElementById('btnCancelTxn').onclick = ()=> dlgTxn.close();

  function openTxn(c, preset){
    const $amt = document.getElementById('tAmount');
    const $note = document.getElementById('tNote');
    const $info = document.getElementById('tInfo');
    const $commit = document.getElementById('btnCommitTxn');
    const typeBtns = [document.getElementById('tBase'), document.getElementById('tQarz'), document.getElementById('tTolov')];

    $amt.value=''; $note.value=''; $info.value='';
    document.getElementById('dlgTxnTitle').textContent =
      preset==='base' ? "Tovar qo'shish (dona)" :
      preset==='qarz' ? "Qarz yozish" :
      preset==='tolov'? "To'lov qabul qilish" : "Yangi yozuv";

    dlgTxn.showModal();
    let selected = preset || null;

    function markActive(){
      typeBtns.forEach(b=>{
        if(b.dataset.type===selected){ b.style.boxShadow='0 0 0 3px rgba(79,140,255,.35)'; }
        else { b.style.boxShadow='none'; }
      });
    }

    function updateInfo(){
      const k = calc(c);
      const val = Number($amt.value||0);
      const berilganJoriy = k.given + k.tolov;
      const qoldiqJoriy   = k.qoldiq;
      let qoldiqYangi = qoldiqJoriy;

      if(selected==='tolov' && val>0){
        qoldiqYangi = Math.max(0, (k.base + k.qarz) - (k.given + k.tolov + val));
      }
      if(selected==='qarz' && val>0){
        qoldiqYangi = Math.max(0, (k.base + k.qarz + val) - (k.given + k.tolov));
      }
      if(selected==='base' && val>0){
        const yangiBase = (k.qty + Math.floor(val)) * k.price;
        qoldiqYangi = Math.max(0, (yangiBase + k.qarz) - (k.given + k.tolov));
      }

      $info.value = `Berilgan (joriy): ${fmt(berilganJoriy)} • Qoldiq (joriy): ${fmt(qoldiqJoriy)}`
                    + (val>0 && selected ? `  →  Kutilgan qoldiq: ${fmt(qoldiqYangi)}` : '');
    }

    typeBtns.forEach(b=> b.onclick = ()=>{ selected=b.dataset.type; markActive(); updateInfo(); });
    if(preset){ markActive(); }
    $amt.oninput = updateInfo;

    $commit.onclick = ()=>{
      const amount = Number($amt.value);
      if(!selected){ alert("Avval amal turini tanlang: Tovar, Qarz yoki To'lov"); return; }
      if(!amount){ alert("Miqdor kiriting"); return; }

      if(selected==='base'){ c.qty = Number(c.qty||0) + Math.floor(amount); }
      else{
        c.txns = c.txns || [];
        c.txns.push({type:selected, amount, note:$note.value.trim(), ts:Date.now()});
      }
      save(); refresh(); dlgTxn.close();
    };

    if(preset==='tolov'){ selected='tolov'; markActive(); updateInfo(); }
  }

  // ------- Report modal (edit qty/price/given live + overview)
  const dlgReport = document.getElementById('dlgReport');
  document.getElementById('btnCancelReport').onclick = ()=> dlgReport.close();
  function openReport(c){
    const fill = ()=>{
      const k = calc(c);
      rQty.value = c.qty||0; rPrice.value = c.price||0; rGiven.value = c.given||0; rPhone.value = c.phone||'';
      rSummary.value = `Asosiy: ${fmt(k.base)} | Jami qarz: ${fmt(k.qarz)} | Jami to'lov: ${fmt(k.given + k.tolov)} | Qoldiq: ${fmt(k.qoldiq)}`;
    };
    dlgReport.showModal(); fill();

    ['rQty','rPrice','rGiven'].forEach(id=>{
      document.getElementById(id).oninput = ()=>{
        const tmp = {...c, qty:Number(rQty.value||0), price:Number(rPrice.value||0), given:Number(rGiven.value||0)};
        const k = calc(tmp);
        rSummary.value = `Asosiy: ${fmt(k.base)} | Jami qarz: ${fmt(k.qarz)} | Jami to'lov: ${fmt(k.given + k.tolov)} | Qoldiq: ${fmt(k.qoldiq)}`;
      };
    });

    document.getElementById('frmReport').onsubmit = (ev)=>{
      ev.preventDefault();
      c.qty = Number(rQty.value||0);
      c.price = Number(rPrice.value||0);
      c.given = Number(rGiven.value||0);
      c.phone = rPhone.value.trim();
      save(); refresh(); dlgReport.close();
    };
  }

  // PWA (bo‘lsa ishlaydi)
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=> navigator.serviceWorker.register('service-worker.js'));
  }
  refresh();
  </script>
</body>
</html>